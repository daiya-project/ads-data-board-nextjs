import{e as S,c as A}from"./index-DEwrhD7r.js";function O(e){const o=`tooltip-${e}`;let n=document.getElementById(o);return n||(n=document.createElement("div"),n.id=o,n.className="chart-glass-tooltip",document.body.appendChild(n)),n}function G(e){if(e.length===0)return"";let o='<div class="cgt-grid">';for(const n of e)o+=`<span class="cgt-dot" style="background:${n.color}"></span>`,o+=`<span class="cgt-label">${n.label}</span>`,o+=`<span class="cgt-value">${n.value}</span>`;return o+="</div>",o}function I(e,o,n,r){const s=o.getBoundingClientRect();let c=s.left+window.scrollX+n;const p=s.top+window.scrollY+r-e.offsetHeight-14,i=e.offsetWidth;c+i/2>window.innerWidth&&(c=window.innerWidth-i-8),c-i/2<0&&(c=i/2+8),e.style.left=c+"px",e.style.top=p+"px",e.style.transform="translateX(-50%)"}const P="'Roboto Mono', 'SF Mono', monospace";function D(){return{font:{family:P,size:11},color:"#9CA3AF"}}function F(){return{color:"rgba(226, 232, 240, 0.4)",drawBorder:!1}}const L="#4A90E2",W="rgba(74, 144, 226, 0.5)",E="#EF4444",B="rgba(239, 68, 68, 0.4)",H="rgba(74, 144, 226, 0.55)",$="rgba(74, 144, 226, 0.8)",N={id:"areaGradientFill",afterLayout(e){const{ctx:o,chartArea:n}=e;if(!n)return;const r=o.createLinearGradient(0,n.top,0,n.bottom);r.addColorStop(0,"rgba(74, 144, 226, 0.3)"),r.addColorStop(.6,"rgba(74, 144, 226, 0.08)"),r.addColorStop(1,"rgba(74, 144, 226, 0)"),e.data.datasets[0].backgroundColor=r}};function Y(e,o){const n=document.getElementById(e);if(!n)return;S.destroy(e);const r=typeof window<"u"&&window.Chart;if(r!=null&&r.getChart){const t=r.getChart(n);t&&t.destroy()}const s=o.daysInMonth,c=[];for(let t=1;t<=s;t++)c.push(`${t}일`);const p=[],i=[],C=[],_=o.lastDataDay,w=new Map(o.data.map(t=>[t.day,t.cumulative])),v=new Map(o.projectedData.map(t=>[t.day,t.cumulative])),k=o.goal/s;for(let t=1;t<=s;t++)w.has(t)?(p.push(w.get(t)),t===_&&_<s?i.push(w.get(t)):i.push(null)):v.has(t)?(p.push(null),i.push(Math.round(v.get(t)))):(p.push(null),i.push(null)),C.push(Math.round(k*t));function f(t){const{chart:l,tooltip:d}=t,u=O(e);if(d.opacity===0){u.style.opacity="0",u.style.pointerEvents="none";return}const x=[];if(d.dataPoints)for(const b of d.dataPoints){const M=b.dataIndex+1,T=w.has(M),m=b.parsed.y;b.datasetIndex===0&&m!==null&&T?x.push({color:L,label:"누적",value:A(m)}):b.datasetIndex===1&&m!==null&&!T?x.push({color:W,label:"예상",value:A(Math.round(m))}):b.datasetIndex===2&&x.push({color:B,label:"목표",value:A(Math.round(C[b.dataIndex]))})}u.innerHTML=G(x),u.style.opacity=x.length>0?"1":"0",u.style.pointerEvents="none",I(u,l.canvas,d.caretX,d.caretY)}const a={id:`verticalGuideLine_${e}`,afterEvent(t){t.draw()},afterDraw(t){var x;const l=t.ctx,d=t.getDatasetMeta(0);if(!((x=d==null?void 0:d.data)!=null&&x.length))return;const u=t.getActiveElements();if(u.length>0){const b=u[0].element.x,M=t.scales.y;l.save(),l.strokeStyle="rgba(156, 163, 175, 0.35)",l.lineWidth=1,l.setLineDash([4,4]),l.beginPath(),l.moveTo(b,M.top),l.lineTo(b,M.bottom),l.stroke(),l.restore()}}},R=new Chart(n,{type:"line",data:{labels:c,datasets:[{label:"누적 매출",data:p,borderColor:L,backgroundColor:"rgba(74, 144, 226, 0.15)",borderWidth:2.5,fill:"origin",tension:.4,pointRadius:2,pointHoverRadius:5,pointBackgroundColor:L,pointBorderColor:"#fff",pointBorderWidth:2,spanGaps:!1},{label:"예측 매출",data:i,borderColor:W,backgroundColor:"transparent",borderWidth:2,borderDash:[6,4],fill:!1,tension:.4,pointRadius:0,spanGaps:!1},{label:"목표선",data:C,borderColor:B,backgroundColor:"transparent",borderWidth:1.5,borderDash:[6,4],fill:!1,pointRadius:0}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{enabled:!1,external:t=>f(t),intersect:!1,mode:"index",position:"nearest",caretPadding:40}},interaction:{mode:"index",intersect:!1,axis:"x"},scales:{y:{beginAtZero:!0,grid:F(),ticks:{...D(),callback:t=>(t/1e8).toFixed(2)+"억"}},x:{grid:{display:!1},ticks:D()}}},plugins:[a,N]});S.register(e,R)}function V(e){if(!e||typeof e!="string")return"";const o=e.slice(0,10);if(o.length<10)return o;const[,n,r]=o.split("-");return`${n}/${r}`}function Z(e,o){const n=document.getElementById(e);if(!n)return;S.destroy(e);const r=typeof window<"u"&&window.Chart;if(r!=null&&r.getChart){const a=r.getChart(n);a&&a.destroy()}const s=[...o].reverse(),c=s.map(a=>V(a.weekStart)),p=s.map(a=>a.revenue),i=s.map(a=>a.clientCount),C=p.map(a=>a/1e8),_=Math.max(0,...i),w=_===0?1:Math.ceil(_*1.15);function v(a){const{chart:R,tooltip:t}=a,l=O(e);if(t.opacity===0){l.style.opacity="0",l.style.pointerEvents="none";return}const d=[];if(t.dataPoints)for(const u of t.dataPoints)u.datasetIndex===0?d.push({color:L,label:"매출",value:A(p[u.dataIndex])}):u.datasetIndex===1&&d.push({color:E,label:"광고주",value:A(u.parsed.y)});l.innerHTML=G(d),l.style.opacity=d.length>0?"1":"0",l.style.pointerEvents="none",I(l,R.canvas,t.caretX,t.caretY)}const k={id:`clientCountLabels_${e}`,afterDraw(a){var R;try{const t=a.ctx,l=a.getDatasetMeta(1);if(!((R=l==null?void 0:l.data)!=null&&R.length))return;t.save(),t.font=`bold 11px ${P}`,t.textAlign="center",t.textBaseline="bottom",l.data.forEach((d,u)=>{const x=i[u];if(x!=null&&typeof d.x=="number"&&typeof d.y=="number"){const b=x.toString(),T=t.measureText(b).width+12,m=18,g=d.x-T/2,y=d.y-12-m;t.fillStyle="rgba(239, 68, 68, 0.08)",t.beginPath();const h=4;t.moveTo(g+h,y),t.lineTo(g+T-h,y),t.arcTo(g+T,y,g+T,y+h,h),t.lineTo(g+T,y+m-h),t.arcTo(g+T,y+m,g+T-h,y+m,h),t.lineTo(g+h,y+m),t.arcTo(g,y+m,g,y+m-h,h),t.lineTo(g,y+h),t.arcTo(g,y,g+h,y,h),t.closePath(),t.fill(),t.fillStyle=E,t.fillText(b,d.x,d.y-14)}}),t.restore()}catch(t){console.error("주간 차트 플러그인 오류:",t)}}},f=new Chart(n,{type:"bar",data:{labels:c,datasets:[{type:"bar",label:"주간 매출",data:C,backgroundColor:H,borderColor:$,borderWidth:1,borderRadius:6,yAxisID:"y",barPercentage:.65,order:1},{type:"line",label:"주간 광고주 수",data:i,borderColor:E,backgroundColor:"transparent",borderWidth:2,tension:.4,yAxisID:"y1",pointRadius:4,pointBackgroundColor:E,pointBorderColor:"#fff",pointBorderWidth:2,order:2}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{enabled:!1,external:a=>v(a)}},scales:{y:{type:"linear",position:"left",beginAtZero:!0,grid:F(),ticks:{...D(),callback:a=>a.toFixed(2)+"억"},title:{display:!1}},y1:{type:"linear",position:"right",beginAtZero:!0,suggestedMax:w,ticks:{callback:a=>a+"개",display:!1},grid:{drawOnChartArea:!1},title:{display:!1}},x:{grid:{display:!1},ticks:D()}}},plugins:[k]});S.register(e,f)}const X=3;function q(e){return e===X}async function U(e,o){const n=await e.from("ads_data_client").select("client_id").eq("second_manager_id",o).neq("manager_id",o);if(n.error)return console.error("[SecondManager] client_id 조회 오류:",n.error),[];const r=n.data;return(r==null?void 0:r.map(s=>s.client_id))??[]}async function z(e,o,n,r){const s=new Map;if(o.length===0)return s;const c=await e.from("ads_data_daily").select("date, amount").in("client_id",o).gte("date",n).lte("date",r).order("date",{ascending:!0});if(c.error)return console.error("[SecondManager] daily amount 조회 오류:",c.error),s;const p=c.data;if(!p)return s;for(const i of p){const C=typeof i.date=="string"?i.date.split("T")[0]:String(i.date),_=parseFloat(String(i.amount))||0;s.set(C,(s.get(C)??0)+_)}return s}async function J(e,o,n){if(o.length===0||n.length===0)return[];const r=await e.from("shared_week").select("start_date, end_date").in("start_date",n).order("start_date",{ascending:!0});if(r.error||!r.data)return[];const s=r.data;if(s.length===0)return[];const c=s[0].start_date,p=s[s.length-1].end_date,i=await e.from("ads_data_daily").select("date, amount, client_id").in("client_id",o).gte("date",c).lte("date",p).order("date",{ascending:!0});if(i.error||!i.data)return[];const C=i.data,_=[];for(const w of s){const v=C.filter(f=>{const a=typeof f.date=="string"?f.date.split("T")[0]:String(f.date);return a>=w.start_date&&a<=w.end_date}),k=new Map;for(const f of v){const a=parseFloat(String(f.amount))||0;k.set(f.client_id,(k.get(f.client_id)??0)+a)}for(const[f,a]of k)_.push({week_start:w.start_date,weekly_amount:a,client_id:f})}return _}export{X as S,Z as a,z as b,J as c,U as f,q as i,Y as r};
