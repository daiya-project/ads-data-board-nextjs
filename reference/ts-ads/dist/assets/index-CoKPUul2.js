import{g as se,a as re,b as x,f as kt,c as T,d as O,h as Bt,e as L,i as le}from"./index-DEwrhD7r.js";import{r as ie,a as ce,i as _t,f as yt,b as Ft,c as de,S as vt}from"./second-manager-B9sUP_Kf.js";function ue(){const t=new Date,n=t.getFullYear(),e=String(t.getMonth()+1).padStart(2,"0");return`${n}-${e}`}const H={selectedMonth:ue(),selectedManagerId:null};function pe(t){if(!t||t.length<7)return"–";const[n,e]=t.split("-");return`${n}년 ${parseInt(e,10)}월`}function gt(t,n){const[e,a]=t.split("-").map(Number),o=new Date(e,a-1+n,1),s=o.getFullYear(),i=o.getMonth()+1;return`${s}-${String(i).padStart(2,"0")}`}function J(t){const n=document.getElementById("goal-month-display");n&&(t&&(n.classList.remove("slide-up","slide-down"),n.offsetWidth,n.classList.add(t==="up"?"slide-up":"slide-down")),n.textContent=pe(H.selectedMonth))}function me(t){J();const n=document.getElementById("goal-month-prev"),e=document.getElementById("goal-month-next");n==null||n.addEventListener("click",()=>{H.selectedMonth=gt(H.selectedMonth,-1),J("down"),t()}),e==null||e.addEventListener("click",()=>{H.selectedMonth=gt(H.selectedMonth,1),J("up"),t()})}async function fe(t){const n=se("goal-monthly-manager-tabs");if(!n)return;const a=(await re()??[]).filter(s=>s.id!==98&&s.id!==99),o=document.createElement("div");o.className="manager-tabs",a.forEach(s=>{var r;const i=((r=s.manager_name)==null?void 0:r.split(" ")[0])??`Manager ${s.id}`,l=document.createElement("button");l.type="button",l.className="manager-tab",l.dataset.managerId=String(s.id),l.textContent=i,l.addEventListener("click",()=>{l.classList.contains("active")?(l.classList.remove("active"),H.selectedManagerId=null,t()):(document.querySelectorAll("#goal-monthly-manager-tabs .manager-tab").forEach(g=>g.classList.remove("active")),l.classList.add("active"),H.selectedManagerId=s.id,t())}),o.appendChild(l)}),n.innerHTML="",n.appendChild(o),requestAnimationFrame(()=>{const s=o.querySelectorAll(".manager-tab");let i=0;s.forEach(l=>{const r=l.getBoundingClientRect().width;r>i&&(i=r)}),i>0&&s.forEach(l=>{l.style.minWidth=`${Math.ceil(i)}px`})})}function Nn(t){const n=document.getElementById("goal-monthly-manager-tabs");n&&n.querySelectorAll(".manager-tab").forEach(e=>{const a=e.dataset.managerId,o=t!==null&&String(t)===a;e.classList.toggle("active",o)})}const ge="goal-monthly-cumulative-chart",he="goal-monthly-weekly-chart";async function _e(t,n){const e=x();if(e){if(typeof window.Chart>"u"){console.error("[Goal Monthly] Chart.js 미로드");return}try{const[a,o]=await Promise.all([ye(e,t,n),ve(e,t,n)]);a&&ie(ge,a),ce(he,o)}catch(a){console.error("[Goal Monthly] 차트 로드 오류:",a)}}}async function ye(t,n,e){const[a,o]=n.split("-").map(Number),s=new Date(a,o-1,1),i=new Date(a,o,0),l=i.getDate(),r=kt(s),g=kt(i);let p=t.from("ads_data_v_daily_summary").select("date, manager_id, daily_amount").gte("date",r).lte("date",g).order("date",{ascending:!0});e&&(p=p.eq("manager_id",e));const d=await p;if(d.error)return console.error("[Goal Monthly] 누적 차트 데이터 조회 오류:",d.error),null;const c=d.data,u=new Map;for(const _ of c??[]){const A=(typeof _.date=="string"?_.date.split("T")[0]:String(_.date)).split("-"),D=parseInt(A[2],10);isNaN(D)||u.set(D,(u.get(D)??0)+(parseFloat(String(_.daily_amount))||0))}if(_t(e)){const _=await yt(t,vt);if(_.length>0){const k=await Ft(t,_,r,g);for(const[A,D]of k){const R=A.split("-"),E=parseInt(R[2],10);isNaN(E)||u.set(E,(u.get(E)??0)+D)}}}let f=0,m=0;const M=[];u.size>0&&(f=Math.max(...u.keys()));for(let _=1;_<=f;_++){const k=u.get(_)??0;m+=k,M.push({day:_,cumulative:m})}const S=f>0?m/f:0,v=[];let C=m;for(let _=f+1;_<=l;_++)C+=S,v.push({day:_,cumulative:C});let y=t.from("ads_data_goal").select("goal_revenue").eq("period_type","monthly").gte("start_date",r).lte("start_date",g);e?y=y.eq("manager_id",e):y=y.is("manager_id",null);const h=await y;let b=0;const w=h.data;if(w&&Array.isArray(w))for(const _ of w)b+=_.goal_revenue??0;return{data:M,projectedData:v,goal:b,daysInMonth:l,lastDataDay:f,averageDailyRevenue:S}}async function ve(t,n,e){let a=t.from("ads_data_v_weekly").select("week_start, week_end, weekly_amount, client_id").order("week_start",{ascending:!1}).limit(1e4);e&&(a=a.eq("manager_id",e));const o=await a;if(o.error)return console.error("[Goal Monthly] 주간 차트 데이터 조회 오류:",o.error),[];const s=o.data;if(!(s!=null&&s.length))return[];const i=[...new Set(s.map(u=>u.week_start))].sort((u,f)=>new Date(f).getTime()-new Date(u).getTime()),l=new Map;for(const u of s)l.has(u.week_start)||l.set(u.week_start,[]),l.get(u.week_start).push(u);const r=s.filter(u=>(typeof u.week_start=="string"?u.week_start.slice(0,7):"")===n),g=[...new Set(r.map(u=>u.week_start))].sort((u,f)=>new Date(f).getTime()-new Date(u).getTime());let p;if(g.length>0){const u=g[0],f=i.indexOf(u);p=f>=0?i.slice(f,f+4):i.slice(0,4)}else p=i.slice(0,4);if(!p.length)return[];let d=[];if(_t(e)){const u=await yt(t,vt);u.length>0&&(d=await de(t,u,p))}const c=[];for(const u of p){const f=l.get(u)??[];let m=f.reduce((v,C)=>v+(parseFloat(String(C.weekly_amount))||0),0);const M=new Set(f.filter(v=>(parseFloat(String(v.weekly_amount))||0)>0&&v.client_id).map(v=>v.client_id)),S=d.filter(v=>v.week_start===u);for(const v of S)m+=v.weekly_amount,v.weekly_amount>0&&v.client_id&&M.add(v.client_id);c.push({weekLabel:u,revenue:m,clientCount:M.size,weekStart:u})}return c}function be(t,n,e,a){const o=document.getElementById(t);if(!o)return;const s=document.createElement("div");s.className="Calendar__root",s.appendChild(we(e,a)),s.appendChild(Ce());for(const i of n.weeks)s.appendChild(Me(i,n.weekdayAvg));o.appendChild(s)}function we(t,n){const[e,a]=t.split("-").map(Number),o=document.createElement("div");o.className="Calendar__monthHeader";const s=document.createElement("button");s.className="Calendar__monthNav",s.type="button",s.innerHTML='<i class="ri-arrow-left-s-line"></i>',s.addEventListener("click",()=>n(-1));const i=document.createElement("span");i.className="Calendar__monthTitle",i.textContent=`${e}년 ${String(a).padStart(2,"0")}월`;const l=document.createElement("button");return l.className="Calendar__monthNav",l.type="button",l.innerHTML='<i class="ri-arrow-right-s-line"></i>',l.addEventListener("click",()=>n(1)),o.appendChild(s),o.appendChild(i),o.appendChild(l),o}function Ce(){const t=document.createElement("div");return t.className="Calendar__headerRow",["월","화","수","목","금","토","일"].forEach((e,a)=>{const o=document.createElement("span");o.className="Calendar__headerDay",a>=5&&o.classList.add("is-weekend"),o.textContent=e,t.appendChild(o)}),t}function Me(t,n){const e=document.createElement("div");return e.className="Calendar__weekBlock",e.dataset.weekId=t.weekId,e.appendChild(ke(t.days,n)),t.goalSummary?e.appendChild(De(t.goalSummary)):e.appendChild(Ae()),e}function Se(t,n){if(n<=0)return"";const e=t/n;return e>=1.3?"amt-very-high":e>=1?"amt-high":e>=.7?"amt-low":"amt-very-low"}function ke(t,n){const e=document.createElement("div");e.className="Calendar__dayGrid";for(const a of t){const o=document.createElement("div");o.className="Calendar__dayCell",o.dataset.date=a.date,a.isCurrentMonth||o.classList.add("is-other-month"),a.isWeekend&&o.classList.add("is-weekend"),a.isHoliday&&o.classList.add("is-holiday"),a.isLatestData&&o.classList.add("is-latest-data"),a.isFuture&&o.classList.add("is-future"),!a.hasData&&!a.isFuture&&!a.isCurrentMonth&&o.classList.add("no-data");const s=document.createElement("div");s.className="Calendar__dayNumber",s.textContent=a.dayLabel,o.appendChild(s);const i=document.createElement("div");if(i.className="Calendar__dayAmount",a.isFuture)i.textContent="";else if(!a.hasData)i.textContent=a.isCurrentMonth?"":"—";else if(i.textContent=T(Math.round(a.amount/1e4))+"만원",a.isCurrentMonth){const l=Se(a.amount,n);l&&i.classList.add(l)}o.appendChild(i),e.appendChild(o)}return e}function Dt(t){return t>=100?"rate-over":t>=85?"rate-high":t>=70?"rate-mid":"rate-low"}function At(t){return T(Math.round(t))}function De(t){const n=document.createElement("div");n.className="Calendar__progressBar";const e=document.createElement("div");if(e.className="Calendar__progressTrack",t.prevWeekAchieved!==null&&t.weekGoal>0){const l=Math.min(t.prevWeekAchieved/t.weekGoal*100,100),r=document.createElement("div");r.className="Calendar__progressPrevMarker",r.style.left=`${l}%`,r.dataset.label="전주",e.appendChild(r)}const a=document.createElement("div"),o=Math.min(t.rate,100);a.className=`Calendar__progressFill ${Dt(t.rate)}`,a.style.width=`${o}%`,e.appendChild(a);const s=document.createElement("div");s.className="Calendar__progressText";const i=Dt(t.rate);return s.innerHTML=`Goal: <strong>${At(t.weekGoal)}</strong> · Achieve: <strong>${At(t.weekAchieved)}</strong> <span class="Calendar__progressRate ${i}">${t.rate.toFixed(1)}%</span>`,e.appendChild(s),n.appendChild(e),n}function Ae(){const t=document.createElement("div");return t.className="Calendar__progressNoGoal",t.textContent="등록된 목표 없음",t}async function Ee(t,n){const e=x();if(!e)return null;const[a,o]=t.split("-").map(Number),s=new Date(a,o,0).getDate(),i=`${t}-01`,l=`${t}-${String(s).padStart(2,"0")}`;try{const r=await $e(e,i,l);if(!r.length)return null;const g=r[0].start_date,p=r[r.length-1].end_date,[d,c,u]=await Promise.all([xe(e,g,p,n),Te(e,i,l,n),Le(e,g,p)]),f=Re(d,n);if(_t(n)){const y=await yt(e,vt);if(y.length>0){const h=await Ft(e,y,g,p);for(const[b,w]of h)f.set(b,(f.get(b)??0)+w)}}const m=Ne(d),M=Ie(d),S=s>0?c/s:0,v=[];for(let y=0;y<r.length;y++){const h=r[y],b=Be(h.start_date,h.end_date,a,o,f,m,u,M),w=h.start_date.slice(5).replace("-","/"),_=h.end_date.slice(5).replace("-","/"),k=b.filter(W=>W.isCurrentMonth).length,A=S*k;let D=0;for(const W of b)W.isCurrentMonth&&W.hasData&&(D+=W.amount);let R=null;if(y>0){const W=v[y-1].days;let U=0;for(const G of W)G.isCurrentMonth&&G.hasData&&(U+=G.amount);R=U}const E=c>0?{weekGoal:A,weekAchieved:D,rate:A>0?D/A*100:0,prevWeekAchieved:R}:null;v.push({weekId:h.week_id,weekLabel:h.week_label,weekRange:`${w} ~ ${_}`,weekStart:h.start_date,weekEnd:h.end_date,days:b,goalSummary:E})}const C=Fe(v);return{weeks:v,weekdayAvg:C,latestDate:M}}catch(r){return console.error("[Goal Monthly] 캘린더 데이터 로드 오류:",r),null}}async function $e(t,n,e){const a=await t.from("shared_week").select("week_id, start_date, end_date, week_label").lte("start_date",e).gte("end_date",n).order("start_date",{ascending:!0});return a.error?(console.error("[Goal Monthly] shared_week 조회 오류:",a.error),[]):a.data??[]}async function xe(t,n,e,a){let o=t.from("ads_data_v_daily_summary").select("date, manager_id, daily_amount, client_count, is_holiday, is_weekend").gte("date",n).lte("date",e).order("date",{ascending:!0});a&&(o=o.eq("manager_id",a));const s=await o;return s.error?(console.error("[Goal Monthly] daily_summary 조회 오류:",s.error),[]):s.data??[]}async function Te(t,n,e,a){let o=t.from("ads_data_goal").select("goal_revenue").eq("period_type","monthly").gte("start_date",n).lte("start_date",e);a?o=o.eq("manager_id",a):o=o.is("manager_id",null);const s=await o;if(s.error)return console.error("[Goal Monthly] 월 목표 조회 오류:",s.error),0;let i=0;const l=s.data;if(l&&Array.isArray(l))for(const r of l)i+=r.goal_revenue??0;return i}async function Le(t,n,e){const a=await t.from("ads_data_daily").select("date").eq("is_holiday",!0).gte("date",n).lte("date",e),o=new Set;if(a.data&&Array.isArray(a.data))for(const s of a.data)o.add(dt(s.date));return o}function dt(t){return typeof t=="string"?t.split("T")[0]:String(t)}function Re(t,n){const e=new Map;for(const a of t){const o=dt(a.date),s=parseFloat(String(a.daily_amount))||0;e.set(o,(e.get(o)??0)+s)}return e}function Ne(t){const n=new Map;for(const e of t){const a=dt(e.date);n.has(a)||n.set(a,{isHoliday:!!e.is_holiday,isWeekend:!!e.is_weekend})}return n}function Ie(t){let n="";for(const e of t){const a=dt(e.date);a>n&&(n=a)}return n}function Be(t,n,e,a,o,s,i,l){const r=[],g=new Date(t+"T00:00:00");for(let p=0;p<7;p++){const d=new Date(g);d.setDate(g.getDate()+p);const c=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`,u=d.getDay(),f=d.getFullYear()===e&&d.getMonth()+1===a,m=s.get(c),M=(m==null?void 0:m.isWeekend)??(u===0||u===6),S=(m==null?void 0:m.isHoliday)??i.has(c),v=o.get(c)??0,C=o.has(c)&&v>0,y=String(d.getMonth()+1).padStart(2,"0"),h=String(d.getDate()).padStart(2,"0");r.push({date:c,dayOfWeek:u===0?6:u-1,dayLabel:`${y}. ${h}.`,amount:v,isCurrentMonth:f,isWeekend:M,isHoliday:S,isLatestData:c===l,isFuture:l?c>l:!1,hasData:C})}return r}function Fe(t){let n=0,e=0;for(const a of t)for(const o of a.days)o.isCurrentMonth&&o.hasData&&(o.isWeekend||o.isHoliday||(n+=o.amount,e++));return e>0?n/e:1}const nt="outbound-cumulative-chart",Et="'Roboto Mono', 'SF Mono', monospace",mt="#4A90E2",ft="#EF4444";function He(t,n){const e=[],a=new Date(t+"T00:00:00"),o=new Date(n+"T00:00:00");for(;a<=o;){const s=a.getFullYear(),i=String(a.getMonth()+1).padStart(2,"0"),l=String(a.getDate()).padStart(2,"0");e.push(`${s}-${i}-${l}`),a.setDate(a.getDate()+1)}return e}function Ht(t){const[n,e,a]=t.split("-");return`${n}년 ${e}월 ${a}일`}function Ot(t,n){const[,e,a]=t.split("-"),[,o,s]=n.split("-");return`${parseInt(e)}월 ${parseInt(a)}일 ~ ${parseInt(o)}월 ${parseInt(s)}일`}function $t(t){const[n,e,a]=t.split("-");return`${n.slice(2)}.${e}.${a}`}function bt(t){if(!t)return{main:"(이름 없음)",sub:""};const n=t.match(/^([^(]+)(.*)$/);if(!n||!n[2])return{main:t.trim(),sub:""};const e=n[1].trim(),a=[],o=/\(([^)]+)\)/g;let s;for(;(s=o.exec(n[2]))!==null;)a.push(s[1].trim());return{main:e,sub:a.join(" | ")}}async function Wt(){const t=x();if(!t)return null;try{const n=await t.from("ads_data_daily").select("date").order("date",{ascending:!1}).limit(1).single();if(n.error||!n.data)return null;const e=n.data;return e.date?e.date.split("T")[0]:null}catch{return null}}async function Oe(t){var e;const n=x();if(!n)return null;try{const a=t.substring(0,7),[o,s]=a.split("-").map(Number),i=new Date(o,s-1-2,1),l=new Date(o,s,0),r=`${i.getFullYear()}-${String(i.getMonth()+1).padStart(2,"0")}-01`,g=`${o}-${String(s).padStart(2,"0")}-${String(l.getDate()).padStart(2,"0")}`,p=await n.from("ads_data_v_outbound").select("client_id, date, amount, outbound_start, outbound_end").gte("date",r).lte("date",g).gte("outbound_start",r).lte("outbound_start",g).order("date",{ascending:!0});if(p.error||!p.data)return O("[Outbound] 뷰 조회 실패:",p.error),null;const d=p.data;if(d.length===0)return null;const c=new Map,u=new Map;for(const y of d){const h=y.date.split("T")[0],b=parseFloat(String(y.amount))||0;c.set(h,(c.get(h)??0)+b),b>0&&(u.has(h)||u.set(h,new Set),u.get(h).add(y.client_id))}const f=He(r,g),m=f.map(y=>{const h=y.split("-");return`${h[1]}/${h[2]}`}),M=t.split("T")[0];let S=f.indexOf(M);if(S<0){for(let y=f.length-1;y>=0;y--)if(c.has(f[y])){S=y;break}}S<0&&(S=0);const v=[],C=[];for(let y=0;y<f.length;y++)if(y<=S){const h=f[y];v.push(c.get(h)??0),C.push(((e=u.get(h))==null?void 0:e.size)??0)}else v.push(null),C.push(null);return{labels:m,dates:f,dailyValues:v,clientCounts:C,lastDataIndex:S}}catch{return null}}async function We(t){const n=x();if(!n)return null;try{const e=t.substring(0,7),[a,o]=e.split("-").map(Number),s=new Date(a,o-1-2,1),i=new Date(a,o,0),l=`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}-01`,r=`${a}-${String(o).padStart(2,"0")}-${String(i.getDate()).padStart(2,"0")}`,g=await n.from("shared_week").select("week_id, week_number, year, start_date, end_date").lte("start_date",r).gte("end_date",l).order("start_date",{ascending:!0});if(g.error||!g.data)return O("[Outbound] shared_week 조회 실패:",g.error),null;const p=g.data;if(p.length===0)return null;const d=await n.from("ads_data_v_outbound").select("client_id, date, amount, outbound_start, outbound_end").gte("date",l).lte("date",r).gte("outbound_start",l).lte("outbound_start",r).order("date",{ascending:!0});if(d.error||!d.data)return O("[Outbound] 주간 뷰 조회 실패:",d.error),null;const c=d.data,u=t.split("T")[0],f=[],m=[],M=[],S=[],v=[];let C=0;for(let y=0;y<p.length;y++){const h=p[y],b=h.start_date.split("T")[0],w=h.end_date.split("T")[0];v.push({start:b,end:w}),m.push(b);const _=b.split("-");if(f.push(`${_[1]}/${_[2]}`),b>u)M.push(null),S.push(null);else{C=y;let k=0;const A=new Set;for(const D of c){const R=D.date.split("T")[0];if(R>=b&&R<=w){const E=parseFloat(String(D.amount))||0;k+=E,E>0&&A.add(D.client_id)}}M.push(k),S.push(A.size)}}return{chartData:{labels:f,dates:m,dailyValues:M,clientCounts:S,lastDataIndex:C},weekRanges:v}}catch{return null}}async function Ge(){const t=x();if(!t)return[];try{const n=await Wt();if(!n)return[];const e=n.substring(0,7),[a,o]=e.split("-").map(Number),s=[];for(let d=2;d>=0;d--){const c=new Date(a,o-1-d,1);s.push(`${c.getFullYear()}-${String(c.getMonth()+1).padStart(2,"0")}`)}const i=`${s[0]}-01`,l=s[s.length-1],r=new Date(parseInt(l.split("-")[0]),parseInt(l.split("-")[1]),0).toISOString().slice(0,10),g=await t.from("ads_data_v_outbound").select("client_id, date, amount").gte("date",i).lte("date",r).order("date",{ascending:!0});if(g.error||!g.data)return[];const p=g.data;return s.map(d=>{const c=p.filter(m=>m.date.split("T")[0].substring(0,7)===d),u=c.reduce((m,M)=>m+(parseFloat(String(M.amount))||0),0),f=new Set(c.filter(m=>(parseFloat(String(m.amount))||0)>0).map(m=>m.client_id)).size;return{month:d,revenue:u,activeClients:f}})}catch(n){return Bt(n,"outbound-section"),[]}}const Gt="outbound-daily-detail-modal",Pt="outbound-weekly-detail-modal",qt="outbound-monthly-detail-modal";async function Pe(t){const n=x();if(n){st();try{const e=await n.from("ads_data_v_outbound").select("client_id, client_name, amount").eq("date",t).order("amount",{ascending:!1});if(e.error||!e.data){O("[Outbound] 모달 데이터 조회 실패:",e.error);return}const a=e.data;if(a.length===0)return;const o=a.filter(p=>(parseFloat(String(p.amount))||0)>0),s=o.length,i=o.reduce((p,d)=>p+(parseFloat(String(d.amount))||0),0),l=document.createElement("div");l.id=Gt,l.className="outbound-modal-overlay";const r=a.map((p,d)=>{const c=parseFloat(String(p.amount))||0,u=c===0,f=u?" outbound-modal-row--zero":"",{main:m,sub:M}=bt(p.client_name),S=M?`<span class="outbound-modal-client-sub">${M}</span>`:"";return`
        <div class="outbound-modal-row${f}">
          <span class="outbound-modal-index">${d+1}</span>
          <span class="outbound-modal-client">
            <span class="outbound-modal-client-main">${m}</span>
            ${S}
          </span>
          <span class="outbound-modal-amount">${u?"0":T(Math.round(c))}</span>
        </div>
      `}).join("");l.innerHTML=`
      <div class="outbound-modal-content">
        <div class="outbound-modal-header">
          <h3 class="outbound-modal-title">${Ht(t)}</h3>
          <div class="outbound-modal-stats">
            <span class="outbound-modal-stat">${s}<span class="outbound-modal-stat-unit">개</span></span>
            <span class="outbound-modal-stat-divider">/</span>
            <span class="outbound-modal-stat">${T(Math.round(i))}<span class="outbound-modal-stat-unit">원</span></span>
          </div>
        </div>
        <div class="outbound-modal-body">
          ${r}
        </div>
      </div>
    `,l.addEventListener("click",p=>{p.target===l&&st()});const g=p=>{p.key==="Escape"&&(st(),document.removeEventListener("keydown",g))};document.addEventListener("keydown",g),document.body.appendChild(l),requestAnimationFrame(()=>{l.classList.add("active")})}catch{}}}function st(){const t=document.getElementById(Gt);t&&(t.classList.remove("active"),setTimeout(()=>t.remove(),200))}async function qe(t,n){const e=x();if(e){rt();try{const a=await e.from("ads_data_v_outbound").select("client_id, client_name, amount").gte("date",t).lte("date",n).order("amount",{ascending:!1});if(a.error||!a.data){O("[Outbound] 주간 모달 데이터 조회 실패:",a.error);return}const o=a.data;if(o.length===0)return;const s=new Map;for(const u of o){const f=parseFloat(String(u.amount))||0,m=s.get(u.client_id);m?m.totalAmount+=f:s.set(u.client_id,{client_id:u.client_id,client_name:u.client_name,totalAmount:f})}const i=[...s.values()].sort((u,f)=>f.totalAmount-u.totalAmount),l=i.filter(u=>u.totalAmount>0),r=l.length,g=l.reduce((u,f)=>u+f.totalAmount,0),p=document.createElement("div");p.id=Pt,p.className="outbound-modal-overlay";const d=i.map((u,f)=>{const m=u.totalAmount===0,M=m?" outbound-modal-row--zero":"",{main:S,sub:v}=bt(u.client_name),C=v?`<span class="outbound-modal-client-sub">${v}</span>`:"";return`
        <div class="outbound-modal-row${M}">
          <span class="outbound-modal-index">${f+1}</span>
          <span class="outbound-modal-client">
            <span class="outbound-modal-client-main">${S}</span>
            ${C}
          </span>
          <span class="outbound-modal-amount">${m?"0":T(Math.round(u.totalAmount))}</span>
        </div>
      `}).join("");p.innerHTML=`
      <div class="outbound-modal-content">
        <div class="outbound-modal-header">
          <h3 class="outbound-modal-title">${Ot(t,n)}</h3>
          <div class="outbound-modal-stats">
            <span class="outbound-modal-stat">${r}<span class="outbound-modal-stat-unit">개</span></span>
            <span class="outbound-modal-stat-divider">/</span>
            <span class="outbound-modal-stat">${T(Math.round(g))}<span class="outbound-modal-stat-unit">원</span></span>
          </div>
        </div>
        <div class="outbound-modal-body">
          ${d}
        </div>
      </div>
    `,p.addEventListener("click",u=>{u.target===p&&rt()});const c=u=>{u.key==="Escape"&&(rt(),document.removeEventListener("keydown",c))};document.addEventListener("keydown",c),document.body.appendChild(p),requestAnimationFrame(()=>{p.classList.add("active")})}catch{}}}function rt(){const t=document.getElementById(Pt);t&&(t.classList.remove("active"),setTimeout(()=>t.remove(),200))}async function Ve(t){var e,a;const n=x();if(n){lt();try{const[o,s]=t.split("-").map(Number),i=`${t}-01`,l=new Date(o,s,0).toISOString().slice(0,10),r=await n.from("ads_data_v_outbound").select("client_id, client_name, amount, outbound_start, outbound_end").gte("date",i).lte("date",l).order("amount",{ascending:!1});if(r.error||!r.data){O("[Outbound] 월별 모달 데이터 조회 실패:",r.error);return}const g=r.data;if(g.length===0)return;const p=new Map;for(const C of g){const y=parseFloat(String(C.amount))||0,h=p.get(C.client_id);h?h.totalAmount+=y:p.set(C.client_id,{client_id:C.client_id,client_name:C.client_name,totalAmount:y,outbound_start:((e=C.outbound_start)==null?void 0:e.split("T")[0])||"",outbound_end:((a=C.outbound_end)==null?void 0:a.split("T")[0])||""})}const d=[...p.values()].sort((C,y)=>y.totalAmount-C.totalAmount),c=d.filter(C=>C.totalAmount>0),u=c.length,f=c.reduce((C,y)=>C+y.totalAmount,0),m=document.createElement("div");m.id=qt,m.className="outbound-modal-overlay";const M=d.map((C,y)=>{const h=C.totalAmount===0,b=h?" outbound-modal-row--zero":"",w=C.outbound_start&&C.outbound_end?`${$t(C.outbound_start)} - ${$t(C.outbound_end)}`:"",{main:_,sub:k}=bt(C.client_name),A=k?`<span class="outbound-modal-client-sub">${k}</span>`:"";return`
        <div class="outbound-modal-row outbound-modal-row--monthly${b}">
          <span class="outbound-modal-index">${y+1}</span>
          <span class="outbound-modal-client">
            <span class="outbound-modal-client-main">${_}</span>
            ${A}
          </span>
          <span class="outbound-modal-period">${w}</span>
          <span class="outbound-modal-amount">${h?"0":T(Math.round(C.totalAmount))}</span>
        </div>
      `}).join(""),S=`${o}년 ${String(s).padStart(2,"0")}월`;m.innerHTML=`
      <div class="outbound-modal-content outbound-modal-content--wide">
        <div class="outbound-modal-header">
          <h3 class="outbound-modal-title">${S}</h3>
          <div class="outbound-modal-stats">
            <span class="outbound-modal-stat">${u}<span class="outbound-modal-stat-unit">개</span></span>
            <span class="outbound-modal-stat-divider">/</span>
            <span class="outbound-modal-stat">${T(Math.round(f))}<span class="outbound-modal-stat-unit">원</span></span>
          </div>
        </div>
        <div class="outbound-modal-body">
          ${M}
        </div>
      </div>
    `,m.addEventListener("click",C=>{C.target===m&&lt()});const v=C=>{C.key==="Escape"&&(lt(),document.removeEventListener("keydown",v))};document.addEventListener("keydown",v),document.body.appendChild(m),requestAnimationFrame(()=>{m.classList.add("active")})}catch{}}}function lt(){const t=document.getElementById(qt);t&&(t.classList.remove("active"),setTimeout(()=>t.remove(),200))}let q=null,K=null;function xt(t,n,e="daily",a=[]){const o=document.getElementById(t);if(!o)return;L.destroy(t);const s=typeof window<"u"&&window.Chart;if(s!=null&&s.getChart){const h=s.getChart(o);h&&h.destroy()}K&&q&&(K.removeEventListener("click",q),q=null,K=null);const{labels:i,dates:l,dailyValues:r,clientCounts:g,lastDataIndex:p}=n,d=g.filter(h=>h!==null),c=Math.max(0,...d),u=c===0?1:Math.ceil(c*1.3);function f(h){const{chart:b,tooltip:w}=h,_=`tooltip-${t}`;let k=document.getElementById(_);if(k||(k=document.createElement("div"),k.id=_,k.className="chart-glass-tooltip",document.body.appendChild(k)),w.opacity===0){k.style.opacity="0",k.style.pointerEvents="none";return}const A=[];let D="";if(w.dataPoints&&w.dataPoints.length>0){const G=w.dataPoints[0].dataIndex;l[G]&&(e==="weekly"&&a[G]?D=`<span class="cgt-date">${Ot(a[G].start,a[G].end)}</span>`:D=`<span class="cgt-date">${Ht(l[G])}</span>`);for(const Z of w.dataPoints){if(Z.parsed.y===null)continue;const ae=e==="weekly"?"주간 매출":"일 매출",oe=e==="weekly"?"활성 광고주":"신규 광고주";Z.datasetIndex===0?A.push(`<span class="cgt-dot" style="background:${mt}"></span><span class="cgt-label">${ae}</span><span class="cgt-value">${T(Math.round(Z.parsed.y))}</span>`):Z.datasetIndex===1&&A.push(`<span class="cgt-dot" style="background:${ft}"></span><span class="cgt-label">${oe}</span><span class="cgt-value">${Z.parsed.y}개</span>`)}}A.length>0?(k.innerHTML=`<div class="cgt-grid">${D}${A.join("")}</div>`,k.style.opacity="1"):k.style.opacity="0",k.style.pointerEvents="none";const R=b.canvas.getBoundingClientRect();let E=R.left+window.scrollX+w.caretX;const W=R.top+window.scrollY+w.caretY-k.offsetHeight-14,U=k.offsetWidth;E+U/2>window.innerWidth&&(E=window.innerWidth-U-8),E-U/2<0&&(E=U/2+8),k.style.left=E+"px",k.style.top=W+"px",k.style.transform="translateX(-50%)"}const m={id:`areaGradient_${t}`,afterLayout(h){const{ctx:b,chartArea:w}=h;if(!w)return;const _=b.createLinearGradient(0,w.top,0,w.bottom);_.addColorStop(0,"rgba(74, 144, 226, 0.25)"),_.addColorStop(.6,"rgba(74, 144, 226, 0.06)"),_.addColorStop(1,"rgba(74, 144, 226, 0)"),h.data.datasets[0].backgroundColor=_}},M={id:`verticalGuide_${t}`,afterDraw(h){const b=h.getActiveElements();if(b.length>0){const w=b[0].element.x,_=h.scales.y,k=h.ctx;k.save(),k.strokeStyle="rgba(156, 163, 175, 0.35)",k.lineWidth=1,k.setLineDash([4,4]),k.beginPath(),k.moveTo(w,_.top),k.lineTo(w,_.bottom),k.stroke(),k.restore()}}},S={id:`monthBoundary_${t}`,afterDraw(h){var k,A;const b=h.ctx,w=h.scales.x,_=h.scales.y;b.save(),b.strokeStyle="rgba(203, 213, 225, 0.5)",b.lineWidth=1,b.setLineDash([6,4]);for(let D=1;D<i.length;D++)if(e==="weekly"?((k=l[D])==null?void 0:k.substring(5,7))!==((A=l[D-1])==null?void 0:A.substring(5,7)):i[D].endsWith("/01")){const E=w.getPixelForValue(D);b.beginPath(),b.moveTo(E,_.top),b.lineTo(E,_.bottom),b.stroke()}b.restore()}},v={id:`todayLine_${t}`,afterDraw(h){if(p<=0||p>=i.length-1)return;const b=h.ctx,w=h.scales.x,_=h.scales.y,k=w.getPixelForValue(p);b.save(),b.strokeStyle="rgba(107, 114, 128, 0.4)",b.lineWidth=1,b.setLineDash([3,3]),b.beginPath(),b.moveTo(k,_.top),b.lineTo(k,_.bottom),b.stroke(),b.restore()}},C=new Chart(o,{type:"line",data:{labels:i,datasets:[{label:"일 매출",data:r,borderColor:mt,backgroundColor:"rgba(74, 144, 226, 0.15)",borderWidth:2,fill:"origin",tension:.3,pointRadius:0,pointHoverRadius:4,pointBackgroundColor:mt,pointBorderColor:"#fff",pointBorderWidth:2,spanGaps:!1,yAxisID:"y",order:2},{label:"신규 광고주 수",data:g,borderColor:ft,backgroundColor:"transparent",borderWidth:2,fill:!1,tension:.4,pointRadius:0,pointHoverRadius:4,pointBackgroundColor:ft,pointBorderColor:"#fff",pointBorderWidth:2,spanGaps:!1,yAxisID:"y1",order:1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{enabled:!1,external:h=>f(h),intersect:!1,mode:"index",position:"nearest",caretPadding:40}},interaction:{mode:"index",intersect:!1,axis:"x"},scales:{y:{type:"linear",position:"left",beginAtZero:!0,grid:{color:"rgba(226, 232, 240, 0.4)",drawBorder:!1},ticks:{font:{family:Et,size:11},color:"#9CA3AF",callback:h=>h>=1e8?(h/1e8).toFixed(1)+"억":h>=1e4?(h/1e4).toFixed(0)+"만":T(h)}},y1:{type:"linear",position:"right",beginAtZero:!0,suggestedMax:u,grid:{drawOnChartArea:!1},ticks:{display:!1}},x:{grid:{display:!1},ticks:{font:{family:Et,size:10},color:"#9CA3AF",maxRotation:0,autoSkip:!1,callback:function(h,b){const w=i[b];return w&&(e==="weekly"||w.endsWith("/01")||w.endsWith("/15"))?w:""}}}}},plugins:[m,M,S,v]});L.register(t,C);const y=o;y.style.cursor="pointer",q=h=>{const w=C.getElementsAtEventForMode(h,"index",{intersect:!1,axis:"x"},!0);if(w.length>0){const _=w[0].index;_<=p&&l[_]&&(e==="weekly"&&a[_]?qe(a[_].start,a[_].end):Pe(l[_]))}},y.addEventListener("click",q),K=y}function ze(t){const n=document.getElementById(t);n&&q&&n.removeEventListener("click",q),q=null,K=null}let at="weekly",tt=null,et=null,wt=[];function Ye(){return`
    <div class="OutboundSection__root">
      <div class="OutboundSection__titleRow">
        <h2 class="OutboundSection__sectionTitle">Out Bound</h2>
        <div class="OutboundSection__chartToggle" id="outbound-chart-toggle">
          <button class="OutboundSection__toggleBtn" data-mode="daily">일간</button>
          <button class="OutboundSection__toggleBtn active" data-mode="weekly">주간</button>
        </div>
      </div>
      <div class="OutboundSection__cumulativeWrapper">
        <canvas id="${nt}"></canvas>
      </div>
      <div id="outbound-monthly-cards-container"></div>
    </div>
  `}function je(t){return t.length?`<div class="OutboundSection__cardsRow">${t.map(e=>{const[a,o]=e.month.split("-"),s=`${a}년 ${o}월`;return`
      <div class="OutboundSection__monthlyCard" data-month="${e.month}" style="cursor:pointer">
        <span class="OutboundSection__cardMonth">${s}</span>
        <div class="OutboundSection__cardRow">
          <span class="OutboundSection__cardLabel">매출</span>
          <span class="OutboundSection__cardValue">${T(Math.round(e.revenue))}</span>
        </div>
        <div class="OutboundSection__cardRow">
          <span class="OutboundSection__cardLabel">활성 광고주</span>
          <span class="OutboundSection__cardValue">${e.activeClients}<span class="OutboundSection__cardUnit">개</span></span>
        </div>
      </div>
    `}).join("")}</div>`:'<div class="empty-state">데이터가 없습니다.</div>'}function Vt(){at==="weekly"&&et&&et.dailyValues.some(t=>t!==null)?xt(nt,et,"weekly",wt):at==="daily"&&tt&&tt.dailyValues.some(t=>t!==null)&&xt(nt,tt,"daily")}function Xe(t){if(t===at)return;at=t;const n=document.getElementById("outbound-chart-toggle");n&&n.querySelectorAll(".OutboundSection__toggleBtn").forEach(e=>{const a=e.dataset.mode;e.classList.toggle("active",a===t)}),Vt()}async function Ue(t){const n=document.getElementById(t);if(n)try{at="weekly",n.innerHTML=Ye();const e=await Wt();if(!e){O("[Outbound] 최신 날짜 없음");return}const[a,o,s]=await Promise.all([Oe(e),We(e),Ge()]);tt=a,et=(o==null?void 0:o.chartData)??null,wt=(o==null?void 0:o.weekRanges)??[],Vt();const i=document.getElementById("outbound-chart-toggle");i&&i.addEventListener("click",r=>{const g=r.target.closest(".OutboundSection__toggleBtn");g&&g.dataset.mode&&Xe(g.dataset.mode)});const l=document.getElementById("outbound-monthly-cards-container");l&&(l.innerHTML=je(s),l.querySelectorAll(".OutboundSection__monthlyCard[data-month]").forEach(r=>{r.addEventListener("click",()=>{const g=r.dataset.month;g&&Ve(g)})}))}catch(e){Bt(e,"outbound-section","아웃바운드 섹션을 로드할 수 없습니다."),n.innerHTML=`
      <div class="OutboundSection__root">
        <div class="empty-state error-state">
          <p>아웃바운드 섹션을 로드할 수 없습니다.</p>
        </div>
      </div>
    `}}function zt(){ze(nt),L.destroy(nt),st(),rt(),lt(),tt=null,et=null,wt=[]}function Ze(t,n,e,a,o){return{id:`maFillBetween_${t}`,beforeDatasetsDraw(s){var d;const i=s,{ctx:l,scales:r}=i;if(!(r!=null&&r.y)||n.length===0||n.length!==e.length)return;const g=i.getDatasetMeta(0);if(!((d=g==null?void 0:g.data)!=null&&d.length))return;const p=n.length;for(let c=0;c<p-1;c++){const u=g.data[c],f=g.data[c+1],m=r.y.getPixelForValue(e[c]),M=r.y.getPixelForValue(e[c+1]),S=(n[c]+n[c+1])/2,v=(e[c]+e[c+1])/2,C=S>=v;l.save(),l.beginPath(),l.moveTo(u.x,u.y),l.lineTo(f.x,f.y),l.lineTo(f.x,M),l.lineTo(u.x,m),l.closePath(),l.fillStyle=C?a:o,l.fill(),l.restore()}}}}function Ke(t){return{id:`verticalGuideLine_${t}`,afterDraw(n){const e=n,a=e.getActiveElements();if(a.length>0){const o=a[0].element.x,s=e.scales.y;e.ctx.save(),e.ctx.strokeStyle="rgba(156, 163, 175, 0.35)",e.ctx.lineWidth=1,e.ctx.setLineDash([4,4]),e.ctx.beginPath(),e.ctx.moveTo(o,s.top),e.ctx.lineTo(o,s.bottom),e.ctx.stroke(),e.ctx.restore()}}}}function Yt(t){return T(t)}function jt(t){return typeof t!="number"?String(t):Math.abs(t)>=1e8?(t/1e8).toFixed(1)+"억":Math.abs(t)>=1e4?(t/1e4).toFixed(0)+"만":T(t)}const Qe={labelActual:"실제값",labelMa:"이동평균(MA)",labelGapPct:"갭(%)",colorActual:"#4A90E2",colorMa:"#64748B",colorAboveMa:"rgba(239, 68, 68, 0.25)",colorBelowMa:"rgba(59, 130, 246, 0.2)",dataFont:"'Roboto Mono', 'SF Mono', monospace",valueFormat:Yt,yAxisTickFormat:jt};function z(t,n,e,a){if(t.length===0)return null;const o=t.reduce((l,r)=>{const g=n(r);return g>l?g:l},n(t[0])),s=t.filter(l=>n(l)===o);if(s.length===0)return null;const i=s.reduce((l,r)=>e(r)>e(l)?r:l,s[0]);return a(i)}function P(t,n,e,a,o,s){const i=Je;return{labels:t.map(l=>i(n(l))),actualData:t.map(l=>e(l)),maData:t.map(l=>a(l)),gapPctData:t.map(l=>o(l))}}function Je(t){const n=String(t).split("-");return n.length>=3?`${n[1]}/${n[2]}`:t}function tn(t){const n=`tooltip-${t}`;let e=document.getElementById(n);return e||(e=document.createElement("div"),e.id=n,e.className="chart-glass-tooltip",document.body.appendChild(e)),e}function en(t){if(t.length===0)return"";let n='<div class="cgt-grid">';for(const e of t)n+=`<span class="cgt-dot" style="background:${e.color}"></span>`,n+=`<span class="cgt-label">${e.label}</span>`,n+=`<span class="cgt-value">${e.value}</span>`;return n+="</div>",n}function nn(t,n,e,a){const o=n.getBoundingClientRect(),s=o.left+window.scrollX+e,i=o.top+window.scrollY+a-t.offsetHeight-14,l=t.offsetWidth;let r=s-l/2;r+l>window.innerWidth&&(r=window.innerWidth-l-8),r<8&&(r=8),t.style.left=r+"px",t.style.top=i+"px",t.style.transform="translateX(-50%)"}function Y(t,n,e={}){const a=document.getElementById(t);if(!a)return;const o=typeof window<"u"&&window.Chart;if(!o)return;L.destroy(t);const s=o.getChart(a);s&&s.destroy();const i={...Qe,...e},{labels:l,actualData:r,maData:g,gapPctData:p}=n,d=tn(t);function c(M){var b,w;const{chart:S,tooltip:v}=M;if(v.opacity===0){d.style.opacity="0",d.style.pointerEvents="none";return}const C=i.valueFormat??Yt,y=[],h=((w=(b=v.dataPoints)==null?void 0:b[0])==null?void 0:w.dataIndex)??0;if(h>=0&&h<l.length){y.push({color:"#94A3B8",label:"날짜",value:l[h]}),y.push({color:i.colorActual,label:i.labelActual,value:C(r[h])}),y.push({color:i.colorMa,label:i.labelMa,value:C(g[h])});const _=p[h],k=_!=null?`${_>=0?"+":""}${_.toFixed(1)}%`:"-";y.push({color:_!=null&&_>=0?"#EF4444":"#3B82F6",label:i.labelGapPct,value:k})}d.innerHTML=en(y),d.style.opacity=y.length>0?"1":"0",d.style.pointerEvents="none",nn(d,S.canvas,v.caretX,v.caretY)}const u=Ze(t,r,g,i.colorAboveMa,i.colorBelowMa),f=Ke(t),m=new o(a,{type:"line",data:{labels:l,datasets:[{label:i.labelActual,data:r,borderColor:i.colorActual,backgroundColor:"transparent",borderWidth:2.5,fill:!1,tension:.35,pointRadius:3,pointHoverRadius:5,pointBackgroundColor:i.colorActual,pointBorderColor:"#fff",pointBorderWidth:2,order:2},{label:i.labelMa,data:g,borderColor:i.colorMa,backgroundColor:"transparent",borderWidth:2,borderDash:[6,4],fill:!1,tension:.35,pointRadius:2,pointHoverRadius:4,pointBackgroundColor:i.colorMa,order:1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{enabled:!1,external:M=>c(M),intersect:!1,mode:"index",position:"nearest",caretPadding:40}},interaction:{mode:"index",intersect:!1,axis:"x"},scales:{y:{type:"linear",position:"left",beginAtZero:!0,grid:{color:"rgba(226, 232, 240, 0.4)",drawBorder:!1},ticks:{font:{family:i.dataFont,size:11},color:"#9CA3AF",callback:M=>(i.yAxisTickFormat??jt)(M)}},x:{grid:{display:!1},ticks:{font:{family:i.dataFont,size:11},color:"#9CA3AF"}}}},plugins:[u,f]});L.register(t,m)}const an="#4A90E2",on="#64748B";function sn(t){const n=`tooltip-${t}`;let e=document.getElementById(n);return e||(e=document.createElement("div"),e.id=n,e.className="chart-glass-tooltip",document.body.appendChild(e)),e}function rn(t,n,e,a){const o=n.getBoundingClientRect(),s=o.left+window.scrollX+e,i=o.top+window.scrollY+a-t.offsetHeight-14,l=t.offsetWidth;let r=s-l/2;r+l>window.innerWidth&&(r=window.innerWidth-l-8),r<8&&(r=8),t.style.left=r+"px",t.style.top=i+"px",t.style.transform="translateX(-50%)"}function ln(t,n,e){const a=document.getElementById(t);if(!a)return;const o=typeof window<"u"&&window.Chart;if(!o)return;L.destroy(t);const s=o.getChart(a);s&&s.destroy();const{tooltipContent:i,colorActual:l=an,colorMa:r=on}=e,{labels:g,actualData:p,maData:d}=n,c=sn(t);function u(m){const{chart:M,tooltip:S}=m;if(S.opacity===0){c.style.opacity="0",c.style.pointerEvents="none";return}c.innerHTML=`<div class="cgt-grid"><span class="cgt-label" style="grid-column: 1 / -1">${le(i)}</span></div>`,c.style.opacity="1",c.style.pointerEvents="none",rn(c,M.canvas,S.caretX,S.caretY)}const f=new Chart(a,{type:"line",data:{labels:g,datasets:[{label:"매출",data:p,borderColor:l,backgroundColor:"transparent",borderWidth:1.5,fill:!1,tension:.35,pointRadius:0,pointHoverRadius:2,order:2},{label:"MA",data:d,borderColor:r,backgroundColor:"transparent",borderWidth:1,borderDash:[4,2],fill:!1,tension:.35,pointRadius:0,pointHoverRadius:2,order:1}]},options:{responsive:!0,maintainAspectRatio:!1,layout:{padding:0},plugins:{legend:{display:!1},tooltip:{enabled:!1,external:m=>u(m),intersect:!1,mode:"index",position:"nearest"}},interaction:{mode:"index",intersect:!1,axis:"x"},scales:{y:{type:"linear",position:"left",beginAtZero:!0,display:!1,grid:{display:!1},ticks:{display:!1}},x:{display:!1,grid:{display:!1},ticks:{display:!1}}}}});L.register(t,f)}const $="ma-chart-revenue-canvas",it="ma-chart-revenue-cards",Xt="ma-chart-revenue-mini-",Ct=8,cn=5;function Mt(t,n,e,a){const o=[...new Set(t.map(n))].sort().reverse(),s=new Set(o.slice(0,cn)),i=new Map;for(const r of t){if(!s.has(n(r)))continue;const g=a(r);i.set(g,(i.get(g)??0)+e(r))}return[...i.entries()].sort((r,g)=>g[1]-r[1]).map(([r])=>r).slice(0,Ct)}async function dn(t,n){if(n.length===0)return new Map;const e=n.map(i=>String(i)),{data:a,error:o}=await t.from("ads_data_client").select("client_id, client_name").in("client_id",e);if(o||!a)return new Map;const s=new Map;for(const i of a){const l=Number(i.client_id);s.set(l,i.client_name??`Client ${i.client_id}`)}return s}async function j(t,n,e,a,o,s){const i=document.getElementById(it);if(!i)return;const{getDate:l,getValue:r,getMa:g,getGapPct:p,getClientId:d}=n,c=s!=null&&s.length>0?s:Mt(t,l,r,d);if(c.length===0){i.innerHTML='<div class="MaChart__empty">데이터가 없습니다.</div>';return}const u=await dn(e,c);i.innerHTML="",i.classList.add("MaChart__cards-container--grid");const f=document.createElement("div");f.className="MaChart__mini-grid";const m=[];for(let M=0;M<Ct;M++){const S=document.createElement("div");if(S.className="MaChart__mini-cell",M<c.length){const v=c[M];a===v&&S.classList.add("MaChart__mini-cell--selected");const y=`${Xt}${M}`,h=document.createElement("canvas");h.id=y,S.appendChild(h),S.setAttribute("data-client-id",String(v)),S.setAttribute("role","button"),S.setAttribute("tabindex","0"),S.addEventListener("click",()=>o(v)),S.addEventListener("keydown",w=>{(w.key==="Enter"||w.key===" ")&&(w.preventDefault(),o(v))});const b=t.filter(w=>d(w)===v).sort((w,_)=>l(w).localeCompare(l(_)));if(b.length>0){const w=P(b,l,r,g,p),_=u.get(v)??`Client ${v}`,k=_.length>20?_.slice(0,20)+"...":_;m.push({canvasId:y,series:w,tooltipContent:`${v}. ${k}`})}f.appendChild(S)}else S.classList.add("MaChart__mini-cell--empty"),f.appendChild(S)}i.appendChild(f);for(const{canvasId:M,series:S,tooltipContent:v}of m)ln(M,S,{tooltipContent:v})}function X(){for(let t=0;t<Ct;t++){const n=`${Xt}${t}`;L.destroy(n);const e=document.getElementById(`tooltip-${n}`);e&&e.remove()}}const un=5*60*1e3,ct=new Map;function Ut(t,n){return`ma_${t??"all"}_${n}`}function ut(t,n){const e=Ut(t,n),a=ct.get(e);return a?Date.now()-a.ts>un?(ct.delete(e),null):a.rows:null}function pt(t,n,e){ct.set(Ut(t,n),{rows:e,ts:Date.now()})}function pn(){ct.clear()}function ot(t){if(document.getElementById(t))return;const n=document.querySelector(".MaChart__chart-wrapper");if(!n)return;const e=document.createElement("canvas");e.id=t,n.innerHTML="",n.appendChild(e)}let N=null;async function mn(t,n){const e=ut(n,"vctr");if(e!=null)return e;const a=1e3;let o=[],s=0,i=!0;for(;i;){const r=n!=null?t.from("ads_data_v_ma_vctr").select("client_id, manager_id, date, vctr, moving_avg, gap_pct_vctr").eq("manager_id",n).order("date",{ascending:!0}).range(s*a,(s+1)*a-1):t.from("ads_data_v_ma_vctr").select("client_id, manager_id, date, vctr, moving_avg, gap_pct_vctr").order("date",{ascending:!0}).range(s*a,(s+1)*a-1),{data:g,error:p}=await r;if(p)return[];const d=g??[];d.length>0?(o=o.concat(d),i=d.length===a,s++):i=!1}const l=o.map(r=>({...r,client_id:typeof r.client_id=="string"?Number(r.client_id):r.client_id,date:typeof r.date=="string"?r.date.split("T")[0]:String(r.date),vctr:Number(r.vctr)||0,moving_avg:Number(r.moving_avg)??0,gap_pct_vctr:r.gap_pct_vctr!=null?Number(r.gap_pct_vctr):null}));return pt(n,"vctr",l),O("[MaChartVctr] fetch 완료, 행 수:",l.length),l}const Tt={getDate:t=>t.date,getValue:t=>t.vctr,getMa:t=>t.moving_avg,getGapPct:t=>t.gap_pct_vctr,getClientId:t=>t.client_id};async function fn(t,n,e){ot(t);const a=x();if(!a)return;const o=await mn(a,n);if(o.length===0){const c=document.querySelector(".MaChart__chart-wrapper");c&&(c.innerHTML='<div class="MaChart__empty" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;">데이터가 없습니다.</div>');return}const s=z(o,c=>c.date,c=>c.vctr,c=>c.client_id),i=N!=null&&o.some(c=>c.client_id===N)?N:s;if(i==null)return;const l=o.filter(c=>c.client_id===i).sort((c,u)=>c.date.localeCompare(u.date));if(l.length===0)return;const r=P(l,c=>c.date,c=>c.vctr,c=>c.moving_avg,c=>c.gap_pct_vctr),g=c=>(Number(c)*100).toFixed(2)+"%",p=c=>(Number(c)*100).toFixed(1)+"%";Y(t,r,{labelActual:"vCTR",labelMa:"이동평균(MA)",labelGapPct:"갭(%)",valueFormat:g,yAxisTickFormat:p});function d(){if(!a||o.length===0)return;const c=N!=null&&o.some(m=>m.client_id===N)?N:z(o,m=>m.date,m=>m.vctr,m=>m.client_id);if(c==null)return;const u=o.filter(m=>m.client_id===c).sort((m,M)=>m.date.localeCompare(M.date));if(u.length===0)return;const f=P(u,m=>m.date,m=>m.vctr,m=>m.moving_avg,m=>m.gap_pct_vctr);Y(t,f,{labelActual:"vCTR",labelMa:"이동평균(MA)",labelGapPct:"갭(%)",valueFormat:g,yAxisTickFormat:p}),X(),j(o,Tt,a,N,m=>{N=m,d()},e)}await j(o,Tt,a,i,c=>{N=c,d()},e)}function Zt(){N=null,L.destroy($);const t=document.getElementById(`tooltip-${$}`);t&&t.remove(),X()}let I=null;async function gn(t,n){const e=ut(n,"cvr");if(e!=null)return e;const a=1e3;let o=[],s=0,i=!0;for(;i;){const r=n!=null?t.from("ads_data_v_ma_cvr").select("client_id, manager_id, date, cvr, moving_avg, gap_pct_cvr").eq("manager_id",n).order("date",{ascending:!0}).range(s*a,(s+1)*a-1):t.from("ads_data_v_ma_cvr").select("client_id, manager_id, date, cvr, moving_avg, gap_pct_cvr").order("date",{ascending:!0}).range(s*a,(s+1)*a-1),{data:g,error:p}=await r;if(p)return[];const d=g??[];d.length>0?(o=o.concat(d),i=d.length===a,s++):i=!1}const l=o.map(r=>({...r,client_id:typeof r.client_id=="string"?Number(r.client_id):r.client_id,date:typeof r.date=="string"?r.date.split("T")[0]:String(r.date),cvr:Number(r.cvr)||0,moving_avg:Number(r.moving_avg)??0,gap_pct_cvr:r.gap_pct_cvr!=null?Number(r.gap_pct_cvr):null}));return pt(n,"cvr",l),O("[MaChartCvr] fetch 완료, 행 수:",l.length),l}const Lt={getDate:t=>t.date,getValue:t=>t.cvr,getMa:t=>t.moving_avg,getGapPct:t=>t.gap_pct_cvr,getClientId:t=>t.client_id};async function hn(t,n,e){ot(t);const a=x();if(!a)return;const o=await gn(a,n);if(o.length===0){const c=document.querySelector(".MaChart__chart-wrapper");c&&(c.innerHTML='<div class="MaChart__empty" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;">데이터가 없습니다.</div>');return}const s=z(o,c=>c.date,c=>c.cvr,c=>c.client_id),i=I!=null&&o.some(c=>c.client_id===I)?I:s;if(i==null)return;const l=o.filter(c=>c.client_id===i).sort((c,u)=>c.date.localeCompare(u.date));if(l.length===0)return;const r=P(l,c=>c.date,c=>c.cvr,c=>c.moving_avg,c=>c.gap_pct_cvr),g=c=>(Number(c)*100).toFixed(2)+"%",p=c=>(Number(c)*100).toFixed(1)+"%";Y(t,r,{labelActual:"CVR",labelMa:"이동평균(MA)",labelGapPct:"갭(%)",valueFormat:g,yAxisTickFormat:p});function d(){if(!a||o.length===0)return;const c=I!=null&&o.some(m=>m.client_id===I)?I:z(o,m=>m.date,m=>m.cvr,m=>m.client_id);if(c==null)return;const u=o.filter(m=>m.client_id===c).sort((m,M)=>m.date.localeCompare(M.date));if(u.length===0)return;const f=P(u,m=>m.date,m=>m.cvr,m=>m.moving_avg,m=>m.gap_pct_cvr);Y(t,f,{labelActual:"CVR",labelMa:"이동평균(MA)",labelGapPct:"갭(%)",valueFormat:g,yAxisTickFormat:p}),X(),j(o,Lt,a,I,m=>{I=m,d()},e)}await j(o,Lt,a,i,c=>{I=c,d()},e)}function Kt(){I=null,L.destroy($);const t=document.getElementById(`tooltip-${$}`);t&&t.remove(),X()}let B=null;async function _n(t,n){const e=ut(n,"cpc");if(e!=null)return e;const a=1e3;let o=[],s=0,i=!0;for(;i;){const r=n!=null?t.from("ads_data_v_ma_cpc").select("client_id, manager_id, date, cpc, moving_avg, gap_pct_cpc").eq("manager_id",n).order("date",{ascending:!0}).range(s*a,(s+1)*a-1):t.from("ads_data_v_ma_cpc").select("client_id, manager_id, date, cpc, moving_avg, gap_pct_cpc").order("date",{ascending:!0}).range(s*a,(s+1)*a-1),{data:g,error:p}=await r;if(p)return[];const d=g??[];d.length>0?(o=o.concat(d),i=d.length===a,s++):i=!1}const l=o.map(r=>({...r,client_id:typeof r.client_id=="string"?Number(r.client_id):r.client_id,date:typeof r.date=="string"?r.date.split("T")[0]:String(r.date),cpc:Number(r.cpc)||0,moving_avg:Number(r.moving_avg)??0,gap_pct_cpc:r.gap_pct_cpc!=null?Number(r.gap_pct_cpc):null}));return pt(n,"cpc",l),O("[MaChartCpc] fetch 완료, 행 수:",l.length),l}const Rt={getDate:t=>t.date,getValue:t=>t.cpc,getMa:t=>t.moving_avg,getGapPct:t=>t.gap_pct_cpc,getClientId:t=>t.client_id};async function yn(t,n,e){ot(t);const a=x();if(!a)return;const o=await _n(a,n);if(o.length===0){const p=document.querySelector(".MaChart__chart-wrapper");p&&(p.innerHTML='<div class="MaChart__empty" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;">데이터가 없습니다.</div>');return}const s=z(o,p=>p.date,p=>p.cpc,p=>p.client_id),i=B!=null&&o.some(p=>p.client_id===B)?B:s;if(i==null)return;const l=o.filter(p=>p.client_id===i).sort((p,d)=>p.date.localeCompare(d.date));if(l.length===0)return;const r=P(l,p=>p.date,p=>p.cpc,p=>p.moving_avg,p=>p.gap_pct_cpc);Y(t,r,{labelActual:"CPC",labelMa:"이동평균(MA)",labelGapPct:"갭(%)"});function g(){if(!a||o.length===0)return;const p=B!=null&&o.some(u=>u.client_id===B)?B:z(o,u=>u.date,u=>u.cpc,u=>u.client_id);if(p==null)return;const d=o.filter(u=>u.client_id===p).sort((u,f)=>u.date.localeCompare(f.date));if(d.length===0)return;const c=P(d,u=>u.date,u=>u.cpc,u=>u.moving_avg,u=>u.gap_pct_cpc);Y(t,c,{labelActual:"CPC",labelMa:"이동평균(MA)",labelGapPct:"갭(%)"}),X(),j(o,Rt,a,B,u=>{B=u,g()},e)}await j(o,Rt,a,i,p=>{B=p,g()},e)}function Qt(){B=null,L.destroy($);const t=document.getElementById(`tooltip-${$}`);t&&t.remove(),X()}let V="rev",St=null;function vn(t){St=t}function bn(t){V=t}function wn(t,n){const e=t.querySelector(".MaChart__metric-toggle");if(!e)return;const a=e.querySelectorAll(".MaChart__toggle-btn");a.forEach(o=>{o.addEventListener("click",async()=>{const s=o.getAttribute("data-metric")??"rev";if(s===V)return;const i=V;V=s,a.forEach(r=>r.classList.toggle("active",r===o)),i==="rev"?n.destroyRev():i==="vctr"?Zt():i==="cvr"?Kt():Qt(),n.ensureCanvas();const l=St;if(s==="rev")await n.renderRev(l);else if(s==="vctr"||s==="cvr"||s==="cpc"){const r=await n.getTop8(l);s==="vctr"?await fn($,l,r):s==="cvr"?await hn($,l,r):await yn($,l,r)}})})}function Cn(t){V==="rev"?t.destroyRev():V==="vctr"?Zt():V==="cvr"?Kt():Qt(),t.resetState(),V="rev",St=null,pn()}let F=null;const Nt={getDate:t=>t.date,getValue:t=>t.amount,getMa:t=>t.moving_avg,getGapPct:t=>t.gap_pct_revenue,getClientId:t=>t.client_id};async function Jt(t,n){const e=ut(n,"rev");if(e!=null)return e;const a=1e3;let o=[],s=0,i=!0;for(;i;){const r=n!=null?t.from("ads_data_v_ma_revenue").select("client_id, manager_id, date, amount, moving_avg, gap_pct_revenue").eq("manager_id",n).order("date",{ascending:!0}).range(s*a,(s+1)*a-1):t.from("ads_data_v_ma_revenue").select("client_id, manager_id, date, amount, moving_avg, gap_pct_revenue").order("date",{ascending:!0}).range(s*a,(s+1)*a-1),{data:g,error:p}=await r;if(p)return[];const d=g??[];d.length>0?(o=o.concat(d),i=d.length===a,s++):i=!1}const l=o.map(r=>({...r,client_id:typeof r.client_id=="string"?Number(r.client_id):r.client_id,date:typeof r.date=="string"?r.date.split("T")[0]:String(r.date),amount:Number(r.amount)??0,moving_avg:Number(r.moving_avg)??0,gap_pct_revenue:r.gap_pct_revenue!=null?Number(r.gap_pct_revenue):null}));return pt(n,"rev",l),l}async function Mn(t){const n=x();if(!n)return[];const e=await Jt(n,t);return Mt(e,a=>a.date,a=>a.amount,a=>a.client_id)}function Sn(){return`
    <div class="MaChart__section">
      <div class="MaChart__grid">
        <div class="MaChart__chart-area">
          <div class="MaChart__header">
            <h4 class="MaChart__title">
              <span class="MaChart__dot"></span>
              광고주 데이터 그래프
            </h4>
          </div>
          <div class="MaChart__chart-wrapper">
            <canvas id="${$}"></canvas>
          </div>
        </div>
        <div class="MaChart__cards-area">
          <div class="MaChart__header">
            <div class="MaChart__metric-toggle" role="group" aria-label="지표 선택">
              <button type="button" class="MaChart__toggle-btn active" data-metric="rev">REV</button>
              <button type="button" class="MaChart__toggle-btn" data-metric="vctr">vCTR</button>
              <button type="button" class="MaChart__toggle-btn" data-metric="cvr">CVR</button>
              <button type="button" class="MaChart__toggle-btn" data-metric="cpc">CPC</button>
            </div>
          </div>
          <div id="${it}" class="MaChart__cards-container">
            <div class="MaChart__empty">당분간 비어 있습니다.</div>
          </div>
        </div>
      </div>
    </div>
  `}async function It(t,n,e){ot(t);const a=x();if(!a)return;const o=await Jt(a,e);if(o.length===0){const d=document.querySelector(".MaChart__chart-wrapper");d&&(d.innerHTML='<div class="MaChart__empty" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;">데이터가 없습니다.</div>');return}const s=Mt(o,d=>d.date,d=>d.amount,d=>d.client_id),i=z(o,d=>d.date,d=>d.amount,d=>d.client_id),l=F!=null&&o.some(d=>d.client_id===F)?F:i;if(l==null)return;const r=o.filter(d=>d.client_id===l).sort((d,c)=>d.date.localeCompare(c.date));if(r.length===0)return;const g=P(r,d=>d.date,d=>d.amount,d=>d.moving_avg,d=>d.gap_pct_revenue);Y(t,g,{labelActual:"매출",labelMa:"이동평균(MA)",labelGapPct:"갭(%)"});function p(){if(!a||o.length===0)return;const d=F!=null&&o.some(f=>f.client_id===F)?F:z(o,f=>f.date,f=>f.amount,f=>f.client_id);if(d==null)return;const c=o.filter(f=>f.client_id===d).sort((f,m)=>f.date.localeCompare(m.date));if(c.length===0)return;const u=P(c,f=>f.date,f=>f.amount,f=>f.moving_avg,f=>f.gap_pct_revenue);Y(t,u,{labelActual:"매출",labelMa:"이동평균(MA)",labelGapPct:"갭(%)"}),X(),j(o,Nt,a,F,f=>{F=f,p()},s)}await j(o,Nt,a,l,d=>{F=d,p()},s)}function te(){L.destroy($);const t=document.getElementById(`tooltip-${$}`);t&&t.remove(),X()}function ee(){F=null}async function kn(t,n,e){const a=document.getElementById(t);if(!a)return;vn(e),bn("rev"),a.innerHTML=Sn(),wn(a,{renderRev:s=>It($,it,s),destroyRev:te,ensureCanvas:()=>ot($),getTop8:Mn,resetState:ee}),await It($,it,e)}function ne(){Cn({destroyRev:te,resetState:ee})}const Dn="goal-monthly-content";let ht=!1;function An(){const t=document.getElementById(Dn);t&&(t.querySelector(".GoalMonthly__chartSection")||(t.innerHTML=`
    <div class="GoalMonthly__chartSection">
      <div class="RevenueChart__container">
        <div class="RevenueChart__wrapper RevenueChart__wrapper--monthly">
          <canvas id="goal-monthly-cumulative-chart"></canvas>
        </div>
        <div class="RevenueChart__wrapper RevenueChart__wrapper--weekly">
          <canvas id="goal-monthly-weekly-chart"></canvas>
        </div>
      </div>
    </div>
    <div id="goal-monthly-revenue-trend-area"></div>
    <div id="goal-monthly-calendar-area"></div>
    <div id="goal-monthly-outbound-section"></div>
  `))}async function Q(){An();const{selectedMonth:t,selectedManagerId:n}=H;ne();const[,e]=await Promise.all([_e(t,n),Ee(t,n),kn("goal-monthly-revenue-trend-area",t,n)]),a=document.getElementById("goal-monthly-calendar-area");a&&(a.innerHTML="",e?be("goal-monthly-calendar-area",e,t,s=>{H.selectedMonth=gt(H.selectedMonth,s),J(),Q()}):a.innerHTML='<p class="empty-state">데이터를 불러올 수 없습니다.</p>');const o=document.getElementById("goal-monthly-outbound-section");o&&(n===3?await Ue("goal-monthly-outbound-section"):(zt(),o.innerHTML=""))}async function En(){if(ht){await Q();return}ht=!0,J(),me(Q),await fe(Q),await Q()}function In(){ht=!1,ne(),zt();const t=document.getElementById("goal-monthly-calendar-area");t&&(t.innerHTML="");const n=document.getElementById("goal-monthly-outbound-section");n&&(n.innerHTML="")}const $n="goal-monthly-tab",xn="goal-monthly-content";function Tn(t){t.innerHTML=`
    <div class="GoalMonthly__header goal-monthly-header">
      <div class="manager-tabs-container goal-monthly-header-tabs" id="goal-monthly-manager-tabs">
        <!-- 매니저 탭 동적 생성 -->
      </div>
      <div class="GoalMonthly__monthPill">
        <button type="button" class="GoalMonthly__monthPillBtn" id="goal-month-prev" aria-label="이전 달">
          <i class="ri-arrow-left-s-line"></i>
        </button>
        <span class="GoalMonthly__monthPillDisplay" id="goal-month-display">2025년 2월</span>
        <button type="button" class="GoalMonthly__monthPillBtn" id="goal-month-next" aria-label="다음 달">
          <i class="ri-arrow-right-s-line"></i>
        </button>
      </div>
    </div>
    <div class="GoalMonthly__content" id="${xn}"></div>
  `}async function Bn(){const t=document.getElementById($n);t&&(t.children.length===0&&Tn(t),await En())}export{In as destroy,Bn as initGoalMonthly,Nn as setActiveManagerTab,H as state,J as updateMonthDisplay};
