var ue=Object.defineProperty;var me=(t,e,a)=>e in t?ue(t,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[e]=a;var M=(t,e,a)=>me(t,typeof e!="symbol"?e+"":e,a);import{f as D,c as k,h as he,d as ge,b as ye}from"./index-DEwrhD7r.js";import{r as Q,a as Z,i as J,f as U,S as X,b as pe,c as fe}from"./second-manager-B9sUP_Kf.js";class ve{constructor(){M(this,"root",null)}render(e){e.insertAdjacentHTML("beforeend",`
      <div class="MonthSelector__controller">
        <div class="MonthSelector__pill">
          <button type="button" class="MonthSelector__pillBtn" id="dashboard-month-prev" aria-label="ì´ì „ ë‹¬">
            <i class="ri-arrow-left-s-line"></i>
          </button>
          <span class="MonthSelector__pillDisplay" id="dashboard-month-display">â€“</span>
          <button type="button" class="MonthSelector__pillBtn" id="dashboard-month-next" aria-label="ë‹¤ìŒ ë‹¬">
            <i class="ri-arrow-right-s-line"></i>
          </button>
        </div>
      </div>
    `),this.root=e.lastElementChild}destroy(){var e;(e=this.root)==null||e.remove(),this.root=null}}class we{constructor(){M(this,"root",null)}render(e){e.insertAdjacentHTML("beforeend",`
      <div id="dashboard-month-picker-modal" class="MonthSelector__pickerOverlay" style="display: none;">
        <div class="MonthSelector__pickerModal">
          <div class="MonthSelector__pickerHeader">
            <span>ì›” ì„ íƒ</span>
            <select id="dashboard-month-picker-year"></select>
          </div>
          <div class="MonthSelector__pickerBody" id="dashboard-month-picker-body"></div>
        </div>
      </div>
    `),this.root=e.lastElementChild}destroy(){var e;(e=this.root)==null||e.remove(),this.root=null}}const _e={daily:"Daily",weekly:"Weekly",monthly:"Monthly",expected:"Expected Monthly"},ke={daily:"ğŸ“…",weekly:"ğŸ“Š",monthly:"ğŸ“ˆ",expected:"ğŸ¯"};class ee{constructor(e){M(this,"root",null);this.options=e}render(e){const{idPrefix:a,variant:n}=this.options,r=_e[n],s=ke[n];if(n==="daily"||n==="weekly"){const l=`
        <div class="KpiCard">
          <div class="KpiCard__header">
            <h3>${r}</h3>
            <div class="KpiCard__icon">${s}</div>
          </div>
          <div class="KpiCard__mainContent">
            <div class="KpiCard__value" id="${a}-${n==="daily"?"daily":"weekly"}-current">0</div>
            <div class="KpiCard__comparison">
              <span class="KpiCard__comparisonLabel">${n==="daily"?"ì „ì¼":"ì „ì£¼"}</span>
              <span class="KpiCard__comparisonValue" id="${a}-${n==="daily"?"daily":"weekly"}-previous">0</span>
            </div>
          </div>
          <div class="KpiCard__changeGroup">
            <span class="KpiCard__changeAmount" id="${a}-${n==="daily"?"daily":"weekly"}-change-amount">0</span>
            <span class="KpiCard__change" id="${a}-${n==="daily"?"daily":"weekly"}-change-rate">0%</span>
          </div>
        </div>
      `;e.insertAdjacentHTML("beforeend",l)}else{const l=n==="monthly"?[{key:"progress",label:"ì›” ê²½ê³¼ìœ¨"},{key:"achievement",label:"ë‹¬ì„±ìœ¨"}]:[{key:"goal",label:"ëª©í‘œ ë§¤ì¶œ"},{key:"achievement",label:"ì˜ˆìƒ ë‹¬ì„±ìœ¨"}],g=n==="monthly"?`${a}-monthly-cumulative`:`${a}-expected-revenue`,y=n==="monthly"?"monthly":"expected",o=l.map(i=>`
        <div class="KpiCard__progressItem">
          <span class="KpiCard__progressLabel">${i.label}</span>
          <span class="KpiCard__progressValue" id="${a}-${y}-${i.key}">0${i.key==="achievement"||i.key==="progress"?"%":""}</span>
        </div>
      `).join(""),c=`
        <div class="KpiCard">
          <div class="KpiCard__header">
            <h3>${r}</h3>
            <div class="KpiCard__icon">${s}</div>
          </div>
          <div class="KpiCard__mainContent">
            <div class="KpiCard__value" id="${g}">0</div>
            <div class="KpiCard__progressInfo">
              ${o}
            </div>
          </div>
        </div>
      `;e.insertAdjacentHTML("beforeend",c)}this.root=e.lastElementChild}destroy(){var e;(e=this.root)==null||e.remove(),this.root=null}}class Ce{constructor(){M(this,"root",null)}render(e){e.insertAdjacentHTML("beforeend",`
      <div class="RevenueChart__card">
        <h3>Monthly Revenue</h3>
        <div class="RevenueChart__container">
          <div class="RevenueChart__wrapper RevenueChart__wrapper--monthly">
            <canvas id="monthly-chart"></canvas>
          </div>
          <div class="RevenueChart__wrapper RevenueChart__wrapper--weekly">
            <canvas id="weekly-chart"></canvas>
          </div>
        </div>
      </div>
    `),this.root=e.lastElementChild}destroy(){var e;(e=this.root)==null||e.remove(),this.root=null}}class De{constructor(){M(this,"kpiCards",[]);M(this,"managerGrid",null);M(this,"managerChartCard",null)}render(e){const a=document.createElement("div");a.className="KpiCard__grid",a.id="manager-kpi-grid",this.managerGrid=a;const n=["daily","weekly","monthly","expected"];this.kpiCards=n.map(s=>new ee({idPrefix:"manager",variant:s})),this.kpiCards.forEach(s=>s.render(a)),e.appendChild(a);const r=document.createElement("div");r.className="RevenueChart__card",r.innerHTML=`
      <div class="ManagerPerformance__header">
        <h3>Manager Performance</h3>
        <div class="Dropdown Dropdown--pill" id="manager-chart-dropdown">
          <button type="button" class="Dropdown__trigger" id="manager-chart-trigger">
            <span class="Dropdown__value" id="manager-chart-value">All</span>
            <i class="ri-arrow-down-s-line Dropdown__chevron"></i>
          </button>
          <div class="Dropdown__menu" id="manager-chart-menu">
            <div class="Dropdown__item active" data-value="">All</div>
          </div>
        </div>
      </div>
      <div class="RevenueChart__container">
        <div class="RevenueChart__wrapper RevenueChart__wrapper--monthly">
          <canvas id="manager-monthly-chart"></canvas>
        </div>
        <div class="RevenueChart__wrapper RevenueChart__wrapper--weekly">
          <canvas id="manager-weekly-chart"></canvas>
        </div>
      </div>
    `,this.managerChartCard=r,e.appendChild(r)}destroy(){var e,a;this.kpiCards.forEach(n=>n.destroy()),this.kpiCards=[],(e=this.managerGrid)==null||e.remove(),this.managerGrid=null,(a=this.managerChartCard)==null||a.remove(),this.managerChartCard=null}}function Me(t){Q("monthly-chart",t)}function Ee(t){Z("weekly-chart",t)}function Ie(t){t&&Q("manager-monthly-chart",t)}function xe(t){Z("manager-weekly-chart",t)}const be="â€“";function T(...t){t.forEach(e=>{const a=document.getElementById(e);a&&(a.textContent=be)})}async function Se(t){try{const{data:e,error:a}=await t.from("ads_data_daily").select("date").order("date",{ascending:!1}).limit(1).single();if(a&&a.code!=="PGRST116"){console.error("Daily KPI: ë§ˆì§€ë§‰ ë‚ ì§œ ì¡°íšŒ ì˜¤ë¥˜:",a);return}if(!e||!e.date)return;const n=new Date(e.date),r=new Date(n);r.setDate(r.getDate()-1);const s=D(n),l=D(r),{data:g,error:y}=await t.from("ads_data_daily").select("date, amount").in("date",[s,l]);if(y){console.error("Daily KPI: ë§¤ì¶œ ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜:",y);return}const o=new Map;(g||[]).forEach(v=>{const w=v.date instanceof Date?D(v.date):typeof v.date=="string"?v.date.split("T")[0]:String(v.date),_=parseFloat(String(v.amount))||0;o.set(w,(o.get(w)||0)+_)});const c=o.get(s)||0,i=o.get(l)||0,u=c-i,m=i>0?(c/i*100-100).toFixed(1):c>0?"âˆ":"0.0",d=document.getElementById("dashboard-daily-current"),h=document.getElementById("dashboard-daily-previous"),p=document.getElementById("dashboard-daily-change-amount"),f=document.getElementById("dashboard-daily-change-rate");d&&(d.textContent=k(c)),h&&(h.textContent=k(i)),p&&(p.textContent=(u>=0?"+":"")+k(u),p.className="KpiCard__changeAmount "+(u>=0?"positive":"negative")),f&&(f.textContent=(u>=0?"+":"")+m+"%",f.className="KpiCard__change "+(u>=0?"positive":"negative"))}catch(e){console.error("Daily KPI ì¹´ë“œ ë¡œë“œ ì˜¤ë¥˜:",e)}}async function Be(t){try{const{data:e,error:a}=await t.from("ads_data_v_weekly").select("week_start, weekly_amount").order("week_start",{ascending:!1}).limit(1e4);if(a){console.error("Weekly KPI: ì£¼ê°„ ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜:",a);return}const n=e;if(!n||n.length===0)return;const r=[...new Set(n.map(f=>f.week_start))].sort((f,v)=>new Date(v).getTime()-new Date(f).getTime());if(r.length<2)return;const s=r[0],l=r[1],g=n.filter(f=>f.week_start===s),y=n.filter(f=>f.week_start===l),o=g.reduce((f,v)=>f+(parseFloat(String(v.weekly_amount))||0),0),c=y.reduce((f,v)=>f+(parseFloat(String(v.weekly_amount))||0),0),i=o-c,u=c>0?(o/c*100-100).toFixed(1):o>0?"âˆ":"0.0",m=document.getElementById("dashboard-weekly-current"),d=document.getElementById("dashboard-weekly-previous"),h=document.getElementById("dashboard-weekly-change-amount"),p=document.getElementById("dashboard-weekly-change-rate");m&&(m.textContent=k(o)),d&&(d.textContent=k(c)),h&&(h.textContent=(i>=0?"+":"")+k(i),h.className="KpiCard__changeAmount "+(i>=0?"positive":"negative")),p&&(p.textContent=(i>=0?"+":"")+u+"%",p.className="KpiCard__change "+(i>=0?"positive":"negative"))}catch(e){console.error("Weekly KPI ì¹´ë“œ ë¡œë“œ ì˜¤ë¥˜:",e)}}function Ke(t){try{const e=t.data.length>0?t.data[t.data.length-1].cumulative:0,a=t.goal||0,n=t.lastDataDay||0,r=t.daysInMonth||30,s=r>0?(n/r*100).toFixed(1):"0.0",l=a>0?(e/a*100).toFixed(1):"0.0",g=document.getElementById("dashboard-monthly-cumulative"),y=document.getElementById("dashboard-monthly-progress"),o=document.getElementById("dashboard-monthly-achievement");g&&(g.textContent=k(e)),y&&(y.textContent=s+"%"),o&&(o.textContent=l+"%")}catch(e){console.error("Monthly KPI ì¹´ë“œ ë¡œë“œ ì˜¤ë¥˜:",e)}}function Re(t){try{const e=t.goal||0,a=t.daysInMonth||30,r=(t.averageDailyRevenue||0)*a,s=e>0?(r/e*100).toFixed(1):"0.0",l=document.getElementById("dashboard-expected-revenue"),g=document.getElementById("dashboard-expected-goal"),y=document.getElementById("dashboard-expected-achievement");l&&(l.textContent=k(Math.round(r))),g&&(g.textContent=k(e)),y&&(y.textContent=s+"%")}catch(e){console.error("Expected Monthly KPI ì¹´ë“œ ë¡œë“œ ì˜¤ë¥˜:",e)}}async function Ae(t,e,a,n){try{a===n&&n!==""?(await Se(t),await Be(t),Re(e)):(T("dashboard-daily-current","dashboard-daily-previous","dashboard-daily-change-amount","dashboard-daily-change-rate"),T("dashboard-weekly-current","dashboard-weekly-previous","dashboard-weekly-change-amount","dashboard-weekly-change-rate"),T("dashboard-expected-revenue","dashboard-expected-goal","dashboard-expected-achievement")),Ke(e)}catch(r){console.error("ëŒ€ì‹œë³´ë“œ KPI ì¹´ë“œ ë¡œë“œ ì˜¤ë¥˜:",r)}}const F=1e3;async function Le(t){const{data:e,error:a}=await t.from("ads_data_daily").select("date").order("date",{ascending:!1}).limit(1).single();if(a||!e||!e.date){const r=new Date;return`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,"0")}`}const n=new Date(e.date);return`${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,"0")}`}async function te(t,e,a){const n=[];let r=!0,s=0,l=t.from("ads_data_daily").select("date, amount").in("date",e).order("date",{ascending:!0});for(a!=null&&(l=l.eq("manager_id",a));r;){const{data:g,error:y}=await l.range(s*F,(s+1)*F-1);if(y)throw new Error(`ì¼ë³„ ë§¤ì¶œ ì¡°íšŒ ì˜¤ë¥˜: ${y.message}`);const o=g??[];o.length>0?(n.push(...o),r=o.length===F,s++):r=!1}return n}async function ae(t,e,a,n){let r=t.from("ads_data_goal").select("goal_revenue").eq("period_type","monthly").gte("start_date",e).lte("start_date",a);n!=null?r=r.eq("manager_id",n):r=r.is("manager_id",null);const{data:s,error:l}=await r.single();return l&&l.code!=="PGRST116"&&console.error("ëª©í‘œ ì¡°íšŒ ì˜¤ë¥˜:",l),s?s.goal_revenue??0:0}async function ne(t,e){let a=t.from("ads_data_v_weekly").select("week_start, week_end, weekly_amount, client_id").order("week_start",{ascending:!1}).limit(1e4);e!=null&&(a=a.eq("manager_id",e));const{data:n,error:r}=await a;return r?(console.error("ì£¼ê°„ ë·° ì¡°íšŒ ì˜¤ë¥˜:",r),[]):n??[]}async function We(t){const{data:e,error:a}=await t.from("shared_manager").select("id, manager_name").eq("manager_team","ads").neq("id",98).neq("id",99).order("id",{ascending:!0});return a?(console.error("ë§¤ë‹ˆì € ëª©ë¡ ì¡°íšŒ ì˜¤ë¥˜:",a),[]):e??[]}async function re(t,e,a,n){let r=t.from("ads_data_daily").select("date").gte("date",e).lte("date",a).order("date",{ascending:!1}).limit(1).single();n!=null&&(r=r.eq("manager_id",n));const{data:s}=await r;return s&&s.date?s.date:null}function oe(t,e,a,n){const r=a.getDate(),s=[],l=[];let g=0;const y=new Map,o=new Set,c=e.getFullYear(),i=e.getMonth()+1;for(const h of t){if(!h.date)continue;let p,f,v;if(typeof h.date=="string"){const _=h.date.split(/[T\s]/)[0].split("-");_.length===3&&(p=parseInt(_[0],10),f=parseInt(_[1],10),v=parseInt(_[2],10))}else h.date instanceof Date&&(p=h.date.getFullYear(),f=h.date.getMonth()+1,v=h.date.getDate());if(p===c&&f===i&&v&&v>=1&&v<=31){const w=parseFloat(String(h.amount))||0;y.set(v,(y.get(v)||0)+w),o.add(v)}}let u=0;o.size>0&&(u=Math.max(...Array.from(o)));for(let h=1;h<=u;h++){const p=y.get(h)||0;g+=p,s.push({day:h,cumulative:g})}const m=u>0?g/u:0;let d=g;for(let h=u+1;h<=r;h++)d+=m,l.push({day:h,cumulative:d});return{data:s,projectedData:l,goal:n,daysInMonth:r,lastDataDay:u,averageDailyRevenue:m}}async function Pe(t,e){const[a,n]=e.split("-").map(Number),r=new Date(a,n-1,1),s=new Date(a,n,0),l=D(r),g=D(s),y=await re(t,l,g,null);let o=s;if(y){const d=new Date(y);d.getFullYear()===a&&d.getMonth()+1===n&&(o=d)}const c=[],i=o.getDate();for(let d=1;d<=i;d++)c.push(D(new Date(a,n-1,d)));const u=await te(t,c,null),m=await ae(t,l,g,null);return oe(u||[],r,s,m)}async function $e(t,e,a){const n=await a(),r=await ne(t,null);return Fe(r,e,n)}async function se(t,e,a){try{const[n,r]=a.split("-").map(Number),s=new Date(n,r-1,1),l=new Date(n,r,0),g=D(s),y=D(l),o=await re(t,g,y,e);let c=l;if(o){const h=new Date(o);h.getFullYear()===n&&h.getMonth()+1===r&&(c=h)}const i=[],u=l.getDate();for(let h=1;h<=u;h++)i.push(D(new Date(n,r-1,h)));let m=await te(t,i,e);if(J(e)){const h=await U(t,X);if(h.length>0){const p=await pe(t,h,g,y);for(const[f,v]of p)m.push({date:f,amount:v})}}const d=await ae(t,g,y,e);return oe(m||[],s,l,d)}catch(n){return console.error("ë§¤ë‹ˆì €ë³„ ì›”ê°„ ë°ì´í„° ê³„ì‚° ì˜¤ë¥˜:",n),null}}async function Te(t,e,a,n){const r=await n(),s=await ne(t,e),{targetWeeks:l,weekLabels:g}=Ne(s,a,r);if(l.length===0)return[];let y=[];if(J(e)){const i=await U(t,X);i.length>0&&(y=await fe(t,i,l))}const o=new Map;for(const i of s){const u=i.week_start;o.has(u)||o.set(u,[]),o.get(u).push(i)}const c=[];for(let i=0;i<l.length;i++){const u=l[i],m=o.get(u)||[];let d=m.reduce((p,f)=>p+(parseFloat(String(f.weekly_amount))||0),0);const h=new Set(m.filter(p=>(parseFloat(String(p.weekly_amount))||0)>0&&p.client_id!=null).map(p=>p.client_id));for(const p of y.filter(f=>f.week_start===u))d+=p.weekly_amount,p.weekly_amount>0&&p.client_id&&h.add(p.client_id);c.push({weekLabel:g[i],revenue:d,clientCount:h.size,weekStart:u})}return c}function Fe(t,e,a){if(!t||t.length===0)return[];const n=[...new Set(t.map(o=>o.week_start))].sort((o,c)=>new Date(c).getTime()-new Date(o).getTime()),r=new Map;for(const o of t){const c=o.week_start;r.has(c)||r.set(c,[]),r.get(c).push(o)}const s=e===a;let l,g;if(s)l=n.slice(0,4),g=["4ì£¼ ì „","3ì£¼ ì „","2ì£¼ ì „","ì „ ì£¼"];else{const o=t.filter(m=>{const d=m.week_start;return(typeof d=="string"?d.slice(0,7):"")===e}),i=[...new Set(o.map(m=>m.week_start))].sort((m,d)=>new Date(d).getTime()-new Date(m).getTime())[0];if(!i)return[];const u=n.indexOf(i);if(u<0)return[];l=n.slice(u,u+4),g=["3ì£¼ ì „","2ì£¼ ì „","1ì£¼ ì „","í•´ë‹¹ ì£¼"]}if(l.length===0)return[];const y=[];for(let o=0;o<l.length;o++){const c=l[o],i=r.get(c)||[],u=i.reduce((d,h)=>d+(parseFloat(String(h.weekly_amount))||0),0),m=new Set(i.filter(d=>(parseFloat(String(d.weekly_amount))||0)>0&&d.client_id!=null).map(d=>d.client_id));y.push({weekLabel:g[o],revenue:u,clientCount:m.size,weekStart:c})}return y}function Ne(t,e,a){const n=[...new Set(t.map(o=>o.week_start))].sort((o,c)=>new Date(c).getTime()-new Date(o).getTime());if(e===a)return{targetWeeks:n.slice(0,4),weekLabels:["4ì£¼ ì „","3ì£¼ ì „","2ì£¼ ì „","ì „ ì£¼"]};const s=t.filter(o=>{const c=o.week_start;return(typeof c=="string"?c.slice(0,7):"")===e}),g=[...new Set(s.map(o=>o.week_start))].sort((o,c)=>new Date(c).getTime()-new Date(o).getTime())[0];if(!g)return{targetWeeks:[],weekLabels:[]};const y=n.indexOf(g);return y<0?{targetWeeks:[],weekLabels:[]}:{targetWeeks:n.slice(y,y+4),weekLabels:["3ì£¼ ì „","2ì£¼ ì „","1ì£¼ ì „","í•´ë‹¹ ì£¼"]}}let le="",ce="";function I(){return le}function L(t){le=t}function W(){return ce}function H(t){ce=t}const qe="â€“";function N(...t){t.forEach(e=>{const a=document.getElementById(e);a&&(a.textContent=qe)})}async function Ge(t,e){try{let a=t.from("ads_data_daily").select("date").order("date",{ascending:!1}).limit(1).single();e&&(a=a.eq("manager_id",e));const{data:n,error:r}=await a;if(r||!n){const C=E=>document.getElementById(E);C("manager-daily-current")&&(C("manager-daily-current").textContent="0"),C("manager-daily-previous")&&(C("manager-daily-previous").textContent="0"),C("manager-daily-change-amount")&&(C("manager-daily-change-amount").textContent="0"),C("manager-daily-change-rate")&&(C("manager-daily-change-rate").textContent="0%");return}const s=n.date,l=new Date(s),g=new Date(l);g.setDate(g.getDate()-1);const y=D(g),o=D(l);let c=t.from("ads_data_daily").select("date, amount").in("date",[o,y]).order("date",{ascending:!1});e&&(c=c.eq("manager_id",e));const{data:i,error:u}=await c;if(u){console.error("ì¼ë³„ ë§¤ì¶œ ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜:",u);return}const m=new Map;(i||[]).forEach(C=>{const E=C.date instanceof Date?D(C.date):typeof C.date=="string"?C.date.split("T")[0]:String(C.date),R=parseFloat(String(C.amount))||0;m.set(E,(m.get(E)||0)+R)});const d=m.get(o)||0,h=m.get(y)||0,p=d-h,f=h>0?(d/h*100-100).toFixed(1):d>0?"âˆ":"0.0",v=document.getElementById("manager-daily-current"),w=document.getElementById("manager-daily-previous"),_=document.getElementById("manager-daily-change-amount"),K=document.getElementById("manager-daily-change-rate");v&&(v.textContent=k(d)),w&&(w.textContent=k(h)),_&&(_.textContent=(p>=0?"+":"")+k(p),_.className="KpiCard__changeAmount "+(p>=0?"positive":"negative")),K&&(K.textContent=(p>=0?"+":"")+f+"%",K.className="KpiCard__change "+(p>=0?"positive":"negative"))}catch(a){console.error("ë§¤ë‹ˆì €ë³„ Daily KPI ì¹´ë“œ ë¡œë“œ ì˜¤ë¥˜:",a)}}async function He(t,e){try{let a=t.from("ads_data_v_weekly").select("week_start, week_end, weekly_amount").order("week_start",{ascending:!1}).limit(1e4);e&&(a=a.eq("manager_id",e));const{data:n,error:r}=await a;if(r){console.error("ì£¼ê°„ ë·° ë°ì´í„° ì¡°íšŒ ì˜¤ë¥˜:",r);return}const s=n;if(!s||s.length===0){["manager-weekly-current","manager-weekly-previous","manager-weekly-change-amount","manager-weekly-change-rate"].forEach(w=>{const _=document.getElementById(w);_&&(_.textContent=w.includes("rate")?"0%":"0")});return}const l=[...new Set(s.map(w=>w.week_start))].sort((w,_)=>new Date(_).getTime()-new Date(w).getTime());if(l.length<2){const w=l[0],K=s.filter($=>$.week_start===w).reduce(($,de)=>$+(parseFloat(String(de.weekly_amount))||0),0),C=document.getElementById("manager-weekly-current");C&&(C.textContent=k(K));const E=document.getElementById("manager-weekly-previous");E&&(E.textContent="0");const R=document.getElementById("manager-weekly-change-amount");R&&(R.textContent="0");const G=document.getElementById("manager-weekly-change-rate");G&&(G.textContent="0%");return}const g=l[0],y=l[1],o=s.filter(w=>w.week_start===g),c=s.filter(w=>w.week_start===y),i=o.reduce((w,_)=>w+(parseFloat(String(_.weekly_amount))||0),0),u=c.reduce((w,_)=>w+(parseFloat(String(_.weekly_amount))||0),0),m=i-u,d=u>0?(i/u*100-100).toFixed(1):i>0?"âˆ":"0.0",h=document.getElementById("manager-weekly-current"),p=document.getElementById("manager-weekly-previous"),f=document.getElementById("manager-weekly-change-amount"),v=document.getElementById("manager-weekly-change-rate");h&&(h.textContent=k(i)),p&&(p.textContent=k(u)),f&&(f.textContent=(m>=0?"+":"")+k(m),f.className="KpiCard__changeAmount "+(m>=0?"positive":"negative")),v&&(v.textContent=(m>=0?"+":"")+d+"%",v.className="KpiCard__change "+(m>=0?"positive":"negative"))}catch(a){console.error("ë§¤ë‹ˆì €ë³„ Weekly KPI ì¹´ë“œ ë¡œë“œ ì˜¤ë¥˜:",a)}}function je(t){try{const e=t.data.length>0?t.data[t.data.length-1].cumulative:0,n=new Date().getDate(),r=t.daysInMonth||30,s=n/r*100,l=t.goal||0,g=l>0?e/l*100:0,y=document.getElementById("manager-monthly-cumulative"),o=document.getElementById("manager-monthly-progress"),c=document.getElementById("manager-monthly-achievement");y&&(y.textContent=k(e)),o&&(o.textContent=s.toFixed(1)+"%"),c&&(c.textContent=g.toFixed(1)+"%")}catch(e){console.error("ë§¤ë‹ˆì €ë³„ Monthly KPI ì¹´ë“œ ë¡œë“œ ì˜¤ë¥˜:",e)}}function Oe(t){try{const e=t.goal||0,a=t.daysInMonth||30,n=new Date().getDate(),r=t.lastDataDay||n,s=t.data.length>0?t.data[t.data.length-1].cumulative:0,l=r>0?s/r:0,g=a-r,y=s+l*g,o=e>0?y/e*100:0,c=document.getElementById("manager-expected-revenue"),i=document.getElementById("manager-expected-goal"),u=document.getElementById("manager-expected-achievement");c&&(c.textContent=k(Math.round(y))),i&&(i.textContent=k(e)),u&&(u.textContent=o.toFixed(1)+"%")}catch(e){console.error("ë§¤ë‹ˆì €ë³„ Expected Monthly KPI ì¹´ë“œ ë¡œë“œ ì˜¤ë¥˜:",e)}}async function j(t,e,a){try{const n=await se(t,e,a);if(!n)return;const r=W();a===r&&r!==""?(await Ge(t,e),await He(t,e),Oe(n)):(N("manager-daily-current","manager-daily-previous","manager-daily-change-amount","manager-daily-change-rate"),N("manager-weekly-current","manager-weekly-previous","manager-weekly-change-amount","manager-weekly-change-rate"),N("manager-expected-revenue","manager-expected-goal","manager-expected-achievement")),je(n)}catch(n){console.error("ë§¤ë‹ˆì €ë³„ KPI ì¹´ë“œ ë¡œë“œ ì˜¤ë¥˜:",n)}}function Ye(t){if(!t||t.length<7)return"â€“";const[e,a]=t.split("-");return`${e}. ${a.padStart(2,"0")}`}function O(t,e){const[a,n]=t.split("-").map(Number),r=new Date(a,n-1+e,1),s=r.getFullYear(),l=r.getMonth()+1;return`${s}-${String(l).padStart(2,"0")}`}function A(t){const e=document.getElementById("dashboard-month-display");e&&(t&&(e.classList.remove("slide-up","slide-down"),e.offsetWidth,e.classList.add(t==="up"?"slide-up":"slide-down")),e.textContent=Ye(I()))}let q=!1;function Ve(){q=!1}function ze(t){if(A(),q)return;q=!0;const e=document.getElementById("dashboard-month-prev"),a=document.getElementById("dashboard-month-next"),n=document.getElementById("dashboard-month-display"),r=document.getElementById("dashboard-month-picker-modal"),s=document.getElementById("dashboard-month-picker-year"),l=document.getElementById("dashboard-month-picker-body");function g(){if(!r||!s||!l)return;const o=I(),[c]=o.split("-").map(Number),i=[c-2,c-1,c,c+1,c+2];s.innerHTML=i.map(u=>`<option value="${u}" ${u===c?"selected":""}>${u}ë…„</option>`).join(""),l.innerHTML="";for(let u=1;u<=12;u++){const m=document.createElement("button");m.type="button",m.textContent=`${u}ì›”`,m.dataset.month=String(u),m.addEventListener("click",()=>{const h=`${parseInt(s.value,10)}-${String(u).padStart(2,"0")}`;L(h),A("up"),r.style.display="none",t()}),l.appendChild(m)}r.style.display="flex"}function y(){r&&(r.style.display="none")}e==null||e.addEventListener("click",()=>{const o=O(I(),-1);L(o),A("down"),t()}),a==null||a.addEventListener("click",()=>{const o=O(I(),1);L(o),A("up"),t()}),n==null||n.addEventListener("click",g),r==null||r.addEventListener("click",o=>{o.target===r&&y()})}async function ie(){if(typeof window.Chart>"u"){console.error("Chart.jsê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. CDN ë§í¬ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");return}const t=ye();if(!t){he(new Error("Supabase í´ë¼ì´ì–¸íŠ¸ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."),"loadDailyReport");return}const e=document.getElementById("monthly-chart"),a=document.getElementById("weekly-chart");if(!e||!a){console.error("ì°¨íŠ¸ Canvas ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");return}try{let n=I();if(!n){const g=await Le(t);L(g),H(g),n=g}const r=W();r||H(n);const s=await Pe(t,n),l=await $e(t,n,()=>Promise.resolve(W()));Me(s),Ee(l),await Ae(t,s,n,r),await Qe(t),ze(()=>{ie()}),ge("ëŒ€ì‹œë³´ë“œ ì°¨íŠ¸ ë¡œë“œ ì™„ë£Œ")}catch(n){console.error("ëŒ€ì‹œë³´ë“œ ì°¨íŠ¸ ë¡œë“œ ì˜¤ë¥˜:",n)}}let Y=!1;async function Qe(t){var e,a;try{const n=await We(t),r=document.getElementById("manager-chart-dropdown"),s=document.getElementById("manager-chart-trigger"),l=document.getElementById("manager-chart-menu"),g=document.getElementById("manager-chart-value");if(!r||!s||!l||!g)return;if(l.querySelectorAll('.Dropdown__item:not([data-value=""]), .glass-dropdown-item:not([data-value=""])').forEach(m=>m.remove()),n&&n.length>0)for(const m of n){const d=document.createElement("div");d.className="Dropdown__item",d.dataset.value=String(m.id),d.textContent=m.manager_name||`Manager ${m.id}`,l.appendChild(d)}const o=s.cloneNode(!0);(e=s.parentNode)==null||e.replaceChild(o,s);const c=o.querySelector(".Dropdown__value, .glass-dropdown-value");o.addEventListener("click",m=>{m.preventDefault(),m.stopPropagation(),r.classList.toggle("open")}),c&&(c.textContent="All");const i=l.cloneNode(!0);(a=l.parentNode)==null||a.replaceChild(i,l),i.querySelectorAll(".Dropdown__item, .glass-dropdown-item").forEach(m=>{const d=m;d.dataset.value===""?d.classList.add("active"):d.classList.remove("active")}),i.addEventListener("click",async m=>{const d=m.target.closest(".Dropdown__item, .glass-dropdown-item");if(!d)return;i.querySelectorAll(".Dropdown__item, .glass-dropdown-item").forEach(v=>v.classList.remove("active")),d.classList.add("active"),c&&(c.textContent=d.textContent??"All"),r.classList.remove("open");const h=d.dataset.value??"",p=h?parseInt(h,10):null,f=I();await V(t,p,f),await j(t,p,f)}),Y||(document.addEventListener("click",m=>{const d=m.target;r.contains(d)||r.classList.remove("open")}),Y=!0);const u=I();await V(t,null,u),await j(t,null,u)}catch(n){console.error("ë§¤ë‹ˆì €ë³„ ê·¸ë˜í”„ ì´ˆê¸°í™” ì˜¤ë¥˜:",n)}}async function V(t,e,a){try{const n=await se(t,e,a),r=await Te(t,e,a,()=>Promise.resolve(W()));n&&Ie(n),xe(r)}catch(n){console.error("ë§¤ë‹ˆì €ë³„ ê·¸ë˜í”„ ë¡œë“œ ì˜¤ë¥˜:",n)}}const Ze=["daily","weekly","monthly","expected"];let x=null,b=null,P=[],S=null,B=null;function z(t){if(t.children.length>0)return;x=new ve,x.render(t);const e=document.createElement("div");e.className="KpiCard__grid",P=Ze.map(n=>new ee({idPrefix:"dashboard",variant:n})),P.forEach(n=>n.render(e)),t.appendChild(e);const a=document.createElement("div");a.className="chart-section",S=new Ce,S.render(a),B=new De,B.render(a),t.appendChild(a),b=new we,b.render(t)}function et(){const t=document.getElementById("dashboard-page");t&&(t.children.length===0&&z(t),(!document.getElementById("monthly-chart")||!document.getElementById("weekly-chart"))&&(t.innerHTML="",z(t)),ie())}function tt(){P.forEach(e=>e.destroy()),P=[],S==null||S.destroy(),S=null,B==null||B.destroy(),B=null,x==null||x.destroy(),x=null,b==null||b.destroy(),b=null,Ve();const t=document.getElementById("dashboard-page");t&&(t.innerHTML="")}export{tt as destroy,z as init,et as initDashboardPage};
