---
description: Rules for generating SQL schemas, Views, and Triggers.
globs: "*.sql"
---

# Database SQL Generation Rules

Whenever generating SQL statements (DDL, Views, Triggers), you **MUST** follow these documentation standards:

## 1. Logical inline comments

Use `--` to explain **why** a specific calculation, `WHERE` clause, or `JOIN` is used inside the query.

```sql
-- Only workdays: exclude public_holidays so YTD sums match business calendar.
SELECT SUM(revenue) FROM ads_data_daily
WHERE is_holiday = false;
```

## 2. Metadata comments (COMMENT ON)

Always append `COMMENT ON TABLE` / `COMMENT ON VIEW` / `COMMENT ON FUNCTION` at the end of the script to explain its **business purpose**.

```sql
COMMENT ON TABLE dna_kpi.monthly_kpi IS 'Wide KPI table: one row per (month, country, type). Target/actual and category columns.';
COMMENT ON VIEW my_schema.revenue_ytd IS 'Year-to-date revenue by client; used for dashboard cards.';
```

## 3. Column comments

Append `COMMENT ON COLUMN` for all **derived**, **calculated**, or **metric-based** columns. Strictly specify **units** (e.g. `%`, KRW) and **formulas** where applicable.

```sql
COMMENT ON COLUMN dna_kpi.monthly_kpi.mf_rate_pct IS 'Target rate 0–100 (%). Used as monthly_mf = monthly_pub * (mf_rate_pct/100).';
COMMENT ON COLUMN my_view.achievement_rate IS 'Derived: actual_monthly / target_monthly when target > 0; unit: ratio (display as %).';
```

---

## Checklist

- [ ] Inline `--` comments explain _why_ for non-obvious logic (calculations, WHERE, JOIN)?
- [ ] Script ends with `COMMENT ON TABLE/VIEW/FUNCTION` for business purpose?
- [ ] Derived/calculated/metric columns have `COMMENT ON COLUMN` with units and formulas?

---

## Suggestions (to refine in this rule or codebase)

- **Trigger comments:** Consider adding `COMMENT ON TRIGGER ... IS '...'` for each trigger (e.g. `tr_monthly_kpi_updated_at` → “Updates updated_at on row change”).
- **Constraint naming:** Document that `CHECK`/unique constraints use a consistent prefix (e.g. `chk_<table>_<column>`, `uq_<table>_<columns>`) and add a short `COMMENT ON CONSTRAINT` where the business rule is non-obvious.
- **Migration order:** If this project uses numbered migrations (e.g. `supabase/migrations/YYYYMMDD_name.sql`), add a note: “One logical change per file; no DROP of objects that other migrations still depend on.”
