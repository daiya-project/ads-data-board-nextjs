---
description: Rules for data types (client_id as string), schema, naming, and data handling.
globs: "app/**/*.ts", "app/**/*.tsx", "lib/**/*.ts", "lib/**/*.tsx", "types/*.ts", "components/**/*.{ts,tsx}"
alwaysApply: true
---

# Data: client_id as String

For identifier consistency, leading-zero preservation, and external system compatibility, treat `client_id` as **string only** everywhere.

## 1. Summary

| Area              | Rule                                                                                     |
| ----------------- | ---------------------------------------------------------------------------------------- |
| **TypeScript**    | `client_id` type is `string` only. Do not use `number` or `Brand<number, 'ClientId'>`    |
| **SQL / DB**      | Column/parameters: `VARCHAR`, `TEXT`, `uuid` etc. Do not use `INTEGER`, `BIGINT`         |
| **API / queries** | Supabase responses, RPC args, CSV/form input: pass and receive `client_id` as **string** |

## 2. TypeScript

```typescript
// ✅ GOOD
type ClientRow = {
  client_id: string;
  client_name: string;
};

function loadByClient(clientId: string) {
  return supabase.from("ads_data_client").select("*").eq("client_id", clientId);
}
```

```typescript
// ❌ BAD
client_id: number;
client_id: Brand<number, 'ClientId'>;
.eq('client_id', Number(id));
```

## 3. SQL / DB

- Table column: `client_id VARCHAR(...)` or `TEXT`, `uuid`.
- RPC/function args: declare as string type; pass only strings when calling.

## 4. API / queries

- Value passed to Supabase `.eq('client_id', value)` must always be `string`.
- From CSV/form: do not parse as number; normalize with `String(...)` if needed.

## 5. Rationale

- **Consistency**: Avoid mixed number/string and comparison/key bugs.
- **Leading zeros**: e.g. `"001"` must not become `1`.
- **Integration**: Align with external systems that use string IDs.

---

# Data Structure & Schema Rules

This file also serves as the **Single Source of Truth** for the project's database schema and data modeling principles.

## 6. Naming Conventions (Strict)

All database columns and related variables must follow these prefixes to ensure clarity and auto-completion grouping:

- **Values (Currency/Integer):** descriptive names (e.g., `actual_monthly`, `target_monthly`, `monthly_ads`). Do not use `val_` prefix.
- **Counts:** `cnt_` (e.g., `cnt_clicks`, `cnt_impressions`)
- **Ratios:** `_rate` suffix (e.g., `achievement_rate`)
- **Percentages:** `_pct` suffix (e.g., `margin_pct`)
- **Dates:** `date_` prefix (e.g., `date_target`, `date_created`)
- **Booleans:** `is_` or `has_` (e.g., `is_active`, `has_permission`)
- **Status:** `status_` (e.g., `status_payment`)

## 7. Schema Strategy

- **Project Schema:** Use `ads` schema for project-specific data.

## 8. Core Tables & Reference Views (`ads` schema)

### 8.1 Example: `monthly_kpi` (Merged Target & Actual)

Stores both monthly targets and accumulated actuals in a single row per category/country/month.

```sql
create table ads.monthly_kpi (
  id bigint generated always as identity primary key,

  -- Dimensions (Unique Constraint Combination)
  data_month date not null,       -- First day of the month (e.g., '2024-03-01')
  category text not null,         -- 'ads' or 'media' (enum-like check)
  country text not null,          -- 'kr' or 'us' (enum-like check)

  -- Actual Columns (Updated continuously via Upsert)
  actual numeric default 0,

  -- Metadata
  updated_at timestamptz default now(),

  -- Constraints
  constraint monthly_kpi_uniq unique (data_month, category, country),
  check (category in ('ads', 'media')),
  check (country in ('kr', 'us'))
);
```

### 8.2 Reference Views (from `shared`)

Do not duplicate shared tables. Use views to mirror them into the `ads` schema for consistent access.

- `ads.ref_manager` → mirrors `shared.manager`
- `ads.ref_week` → mirrors `shared.week`
- `ads.ref_holiday` → mirrors `shared.holiday`

**Usage:** These reference views are read-only. Apply any data changes in the original `shared` schema; the views reflect the source tables.

## Checklist

- [ ] TS types define `client_id` as `string`?
- [ ] Supabase/RPC calls pass only strings for `client_id`?
- [ ] CSV/form input never converts `client_id` to number?
- [ ] New DB columns follow naming conventions (cnt_, _rate, _pct, date_, is_, has_, status_)?
- [ ] Project-specific data uses `ads` schema; shared reference via views only?
